<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ÔN TẬP GS TỪ VỰNG & NGỮ PHÁP (LỚP 4 - 9)</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --secondary-color: #2c3e50;
            --accent-color: #FFD700;
            --warning-color: #FF6347;
            --error-color: #f44336;
            --info-color: #2196F3;
            --purple-color: #9C27B0;
            --light-bg: #f5f5f5;
            --white: #ffffff;
            --border-radius: 12px;
            --box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            --card-shadow: 0 2px 8px rgba(0,0,0,0.05);
            --grammar-color: #FF9800;
            --grammar-blue: #1890ff;
            --vocab-dark-green: #004d00;
            
            /* Màu sắc cho các lớp mới */
            --grade4-color: #00BCD4; /* Cyan */
            --grade5-color: #FF9800; /* Orange */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 10px; /* Giảm padding body trên mobile */
            background-color: var(--light-bg);
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* --- Header Styles --- */
        .header {
            width: 100%;
            text-align: center;
            margin-bottom: 15px; /* Giảm margin */
            color: var(--secondary-color);
        }
        
        .header h1 {
            margin: 0;
            font-size: 22px; /* Giảm chút font tiêu đề */
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1.2;
        }
        
        .header h2 {
            margin: 5px 0 0;
            font-size: 18px; /* Giảm font phụ đề */
            font-weight: 600;
            color: var(--secondary-color);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
        }

        /* --- Common Screen Styles --- */
        .login-screen, .quiz-screen, .result-screen, .main-menu, .review-menu, .vocabulary-list, .grade-selection, .auto-review-screen {
            width: 100%;
            background-color: var(--white);
            padding: 15px; /* Giảm padding chung để tiết kiệm không gian */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 10px; } /* Giảm khoảng cách giữa các nhóm form */
        .form-group label {
            display: block;
            margin-bottom: 5px; /* Giảm margin label */
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 14px;
        }
        
        input, button, select {
            width: 100%;
            padding: 10px 12px; /* Giảm padding input */
            margin: 5px 0; /* Giảm margin input */
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            background-color: #fff;
        }
        
        select option:disabled {
            color: #999;
            font-style: italic;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.5px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 10px; /* Giảm padding nút */
        }
        
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); }
        button:disabled { background-color: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #1a252f; }
        
        .btn-comprehensive { background-color: var(--purple-color); }
        .btn-comprehensive:hover { background-color: #7b1fa2; }

        .btn-grammar { background-color: var(--grammar-color); }
        .btn-grammar:hover { background-color: #F57C00; }

        .back-button { background-color: #6c757d; margin-top: 10px; }
        .back-button:hover { background-color: #5a6268; }

        /* --- NÚT LEVEL --- */
        #grade4-btn { background-color: var(--grade4-color); } #grade4-btn:hover { background-color: #0097A7; }
        #grade5-btn { background-color: var(--grade5-color); } #grade5-btn:hover { background-color: #F57C00; }
        #grade6-btn { background-color: #1890ff; } #grade6-btn:hover { background-color: #096dd9; }
        #grade7-btn { background-color: #fa8c16; } #grade7-btn:hover { background-color: #d46b08; }
        #grade8-btn { background-color: #52c41a; } #grade8-btn:hover { background-color: #389e0d; }
        #grade9-btn { background-color: #f5222d; } #grade9-btn:hover { background-color: #cf1322; }

        /* --- Range Tests Styles --- */
        .range-tests-container { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; /* Giảm gap */
            margin: 10px 0; 
        }
        
        .range-tests-row { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
            justify-content: center; /* Căn giữa nếu thiếu nút */
        }
        
        .range-tests-row button { 
            flex: 1; 
            min-width: 45%; /* Đảm bảo 2 nút mỗi hàng ngay cả trên mobile nhỏ */
            font-size: 13px; /* Giảm font chữ cho vừa khung */
            padding: 10px 5px; /* Giảm padding */
            text-align: center; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Màu sắc cho các nút Range Test */
        .btn-range-u1-u5 { background-color: #00BCD4; } .btn-range-u1-u5:hover { background-color: #0097A7; }
        .btn-range-u6-u10 { background-color: #FF5722; } .btn-range-u6-u10:hover { background-color: #E64A19; }
        .btn-range-u1-u10 { background-color: #E91E63; } .btn-range-u1-u10:hover { background-color: #C2185B; }
        .btn-range-u11-u15 { background-color: #3F51B5; } .btn-range-u11-u15:hover { background-color: #303F9F; }
        .btn-range-u16-u20 { background-color: #795548; } .btn-range-u16-u20:hover { background-color: #5D4037; }
        .btn-range-u11-u20 { background-color: #FF9800; } .btn-range-u11-u20:hover { background-color: #F57C00; }

        /* --- Quiz Screen Styles --- */
        .timer-container { width: 100%; background-color: #f1f1f1; border-radius: var(--border-radius); margin-bottom: 15px; overflow: hidden; height: 10px; }
        .timer-bar { height: 100%; background-color: var(--accent-color); border-radius: var(--border-radius); width: 100%; transition: width 0.1s linear; }
        
        .question { font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center; color: var(--secondary-color); }
        
        .word-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .word {
            font-size: 24px; /* Giảm font chữ câu hỏi trên mobile */
            font-weight: bold;
            color: var(--secondary-color);
            text-align: center;
            padding: 8px 15px;
            background-color: rgba(76, 175, 80, 0.1);
            border-radius: var(--border-radius);
            word-break: break-word;
        }
        
        .speaker-btn {
            background: none; border: none; cursor: pointer; width: 36px; height: 36px; padding: 6px;
            border-radius: 50%; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
            background-color: rgba(76, 175, 80, 0.1); flex-shrink: 0;
        }
        .speaker-btn:hover { background-color: rgba(76, 175, 80, 0.2); transform: scale(1.05); }
        .speaker-btn:active { transform: scale(0.95); }
        .speaker-icon { width: 20px; height: 20px; fill: var(--primary-color); }
        .hidden-speaker { display: none !important; }
        
        .options { display: flex; flex-direction: column; gap: 8px; }
        .option {
            padding: 12px; /* Giảm padding option */
            background-color: #f9f9f9; border: 1px solid #ddd; border-radius: var(--border-radius);
            cursor: pointer; text-align: left; transition: all 0.2s ease; word-wrap: break-word;
            font-size: 16px; 
            font-weight: 500;
            line-height: 1.4;
        }
        .option:hover { background-color: #e9e9e9; transform: translateX(3px); }
        .correct { background-color: var(--primary-color) !important; color: var(--white) !important; border-color: var(--primary-dark) !important; }
        .incorrect { background-color: var(--error-color) !important; color: var(--white) !important; border-color: #d32f2f !important; }
        
        .stats-container { display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; font-size: 14px; }
        .question-counter, .streak { font-weight: bold; color: var(--secondary-color); margin: 2px 0; }

        /* --- RESULT SCREEN DASHBOARD (DESKTOP DEFAULT) --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Mặc định 2 cột (Desktop) */
            gap: 10px; 
            margin-bottom: 10px; 
        }

        .main-result-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 14px; /* CHỈNH SỬA: Tăng padding từ 10px lên 14px */
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 0.2s;
        }
        .main-result-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .result-user-name { 
            font-size: 32px; /* CHỈNH SỬA: Tăng từ 28px lên 32px */
            font-weight: 800; 
            margin-bottom: 5px; 
            text-transform: capitalize; 
        }

        .chart-container-wrapper {
            position: relative;
            width: 192px; /* CHỈNH SỬA: Tăng từ 160px lên 192px (tăng 20%) */
            height: 192px;
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .circular-chart { display: block; max-width: 100%; max-height: 100%; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        
        .percentage-text { fill: #666; font-family: sans-serif; font-weight: bold; font-size: 0.5em; text-anchor: middle; }
        
        .score-mini-info {
            position: absolute;
            top: 65%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 100%;
        }
        .score-mini-text { 
            display: block; 
            /* CHỈNH SỬA MỚI: TĂNG KÍCH THƯỚC FONT TỪ 14px LÊN 18px (TĂNG ~30%) */
            font-size: 18px; 
            color: #888; 
            font-weight: 600; 
        } 
        .score-mini-num { font-weight: bold; color: var(--secondary-color); }

        .result-date-display {
            margin-top: 8px;
            font-size: 13px;
            color: #003366; 
            font-weight: bold; 
            background-color: #f9f9f9;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .stats-grid-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 14px; /* CHỈNH SỬA: Tăng padding từ 10px lên 14px */
            box-shadow: var(--card-shadow);
            display: grid;
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr;
            gap: 10px; /* CHỈNH SỬA: Tăng gap từ 8px lên 10px cho thoáng hơn */
        }

        .mini-stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px; 
            border-radius: 8px;
            background-color: #fcfcfc;
            border: 1px solid #f0f0f0;
        }

        .mini-stat-icon { 
            width: 38px; /* CHỈNH SỬA: Tăng từ 32px lên 38px */
            height: 38px; 
            margin-bottom: 4px; 
        } 
        .mini-stat-label { 
            font-size: 13px; /* CHỈNH SỬA: Tăng từ 11px lên 13px */
            text-transform: uppercase; 
            color: #999; 
            margin-bottom: 2px; 
        } 
        .mini-stat-value { 
            font-size: 22px; /* CHỈNH SỬA: Tăng từ 18px lên 22px */
            font-weight: 700; 
            color: var(--secondary-color); 
        } 
        .mini-stat-sub { font-size: 10px; color: #aaa; } 

        .mini-stat-card.time-start .mini-stat-icon { fill: var(--info-color); }
        .mini-stat-card.time-end .mini-stat-icon { fill: #e91e63; }
        .mini-stat-card.streak .mini-stat-icon { fill: var(--purple-color); }
        .mini-stat-card.total-time .mini-stat-icon { fill: var(--warning-color); }
        .mini-stat-card.total-time .mini-stat-value { color: var(--warning-color); }

        /* --- Cheat Warning Box --- */
        .cheating-alert {
            width: 100%;
            background-color: #ffebee;
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 8px; 
            margin-bottom: 8px; 
            text-align: center;
            color: #d32f2f;
            display: none; 
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.2);
            animation: pulse 2s infinite;
        }

        .cheating-alert h3 {
            margin: 0 0 4px 0; 
            font-size: 14px;
            text-transform: uppercase;
            font-weight: 900;
        }

        .cheating-alert p {
            margin: 0;
            font-size: 12px; 
            font-weight: 600;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        /* --- List/History Styles --- */
        .result-section-title { margin-top: 10px; margin-bottom: 6px; color: var(--secondary-color); font-size: 16px; border-left: 4px solid var(--primary-color); padding-left: 8px; }
        .wrong-questions-list { list-style-type: none; padding: 0; margin-top: 5px; }
        .wrong-questions-list li { background-color: #fff5f5; border-left: 3px solid var(--error-color); padding: 6px; margin-bottom: 4px; font-size: 13px; color: #555; }
        
        .answer-history { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; background: #fff; }
        .answer-history th, .answer-history td { border: 1px solid #ddd; padding: 6px; text-align: left; word-wrap: break-word; }
        .answer-history th { background-color: #f2f2f2; font-weight: 600; color: var(--secondary-color); }
        .answer-history tr:nth-child(even) { background-color: #f9f9f9; }
        .result-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .result-buttons button { flex: 1; min-width: 100px; }
        .hidden { display: none !important; }
        
        /* --- Other Screens --- */
        .progress-container { width: 100%; background-color: #f1f1f1; border-radius: var(--border-radius); margin: 10px 0; overflow: hidden; height: 8px; }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: var(--border-radius); transition: width 0.3s ease, background-color 0.3s ease; }
        .progress-text { text-align: center; font-size: 14px; color: var(--secondary-color); margin-bottom: 5px; }
        .menu-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .grade-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }

        /* --- Vocabulary List --- */
        .vocabulary-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .vocabulary-table th, .vocabulary-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .vocabulary-table th { background-color: #f2f2f2; font-weight: 600; font-size: 12px; }
        .vocabulary-word { display: flex; align-items: center; gap: 5px; }

        /* --- Contact & Auto Review --- */
        .contact-info { background-color: var(--white); padding: 12px; border-radius: var(--border-radius); margin-bottom: 12px; box-shadow: var(--card-shadow); }
        .contact-info h3 { color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 0; font-size: 16px;}
        .contact-info p { margin: 5px 0; line-height: 1.4; font-size: 13px;}
        .social-icon { width: 16px; height: 16px; vertical-align: middle; margin-right: 5px; fill: #555; }

        .auto-review-word { font-size: 28px; font-weight: bold; text-align: center; margin: 20px 0; color: var(--white); transition: color 0.3s ease; word-wrap: break-word; }
        .auto-review-word.black { color: #000; font-weight: bold; }
        .auto-review-meaning { font-size: 18px; text-align: center; margin-bottom: 20px; color: var(--secondary-color); }
        .auto-review-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        
        /* --- Toast Notification Styles --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background-color: #333;
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 200px;
            font-size: 14px;
            animation: slideIn 0.3s ease-out forwards, fadeOut 0.5s ease-in 2.5s forwards;
            opacity: 0;
            transform: translateX(100%);
        }

        .toast.success { background-color: var(--primary-color); }
        .toast.error { background-color: var(--error-color); }
        .toast.warning { background-color: var(--warning-color); }

        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Responsive cho Mobile */
        @media (max-width: 480px) {
            .header h1 { font-size: 18px; }
            .header h2 { font-size: 16px; }
            
            /* --- GIỮ NGUYÊN 1 CỘT TRÊN MOBILE --- */
            .dashboard-grid { 
                grid-template-columns: 1fr; /* Chỉ còn 1 cột */
                gap: 8px; /* Giảm gap trên mobile */
            }

            /* --- GIỮ NGUYÊN KÍCH THƯỚC BIỂU ĐỒ TRÊN MOBILE (Ghi đè desktop) --- */
            .chart-container-wrapper {
                width: 200px !important; 
                height: 200px !important;
                margin: 5px 0; 
            }

            .circular-chart { width: 100%; height: 100%; }
            
            /* --- GIỮ NGUYÊN FONT SIZE PHẦN TRĂM TRÊN MOBILE --- */
            .percentage-text { 
                font-size: 0.6em !important; 
            } 

            /* --- GIỮ NGUYÊN PADDING TRÊN MOBILE --- */
            .main-result-card { padding: 8px !important; }
            .result-user-name { font-size: 24px !important; margin-bottom: 2px; }
            
            /* --- GIỮ NGUYÊN PADDING CHA --- */
            .stats-grid-card {
                padding: 8px !important; 
                gap: 5px !important; 
            }
            
            /* --- CHỈNH SỬA LỖI MOBILE: TRỞ LẠI HIỂN THỊ DỌC (COLUMN) --- */
            .mini-stat-card {
                padding: 6px !important; 
                flex-direction: column !important; /* Quan trọng: Dùng layout dọc để tránh bị ép ngang */
                align-items: center !important;
                justify-content: center !important;
                gap: 2px;
            }
            .mini-stat-icon { width: 28px !important; height: 28px !important; margin-bottom: 2px; }
            .mini-stat-label { 
                font-size: 10px !important; 
                margin-bottom: 0; 
                text-align: center !important; /* Căn giữa khi hiển thị dọc */
            } 
            .mini-stat-value { 
                font-size: 16px !important; 
                text-align: center !important; /* Căn giữa khi hiển thị dọc */
            } 
            .mini-stat-sub { 
                font-size: 9px; 
                text-align: center !important; /* Căn giữa khi hiển thị dọc */
                display: block; 
            }
            
            /* CHỈNH SỬA MỚI MOBILE: TĂNG FONT SIZE SCORE MINI TEXT TỪ 12px LÊN 16px */
            .score-mini-text { font-size: 16px !important; font-weight: bold; }
            .score-mini-num { font-size: 1.1em; }
            
            .result-date-display { font-size: 11px !important; padding: 3px 10px; margin-top: 5px; }
            
            .answer-history th, .answer-history td { padding: 4px; font-size: 11px; }
            .wrong-questions-list li { font-size: 12px; padding: 4px; }
            
            .result-buttons { gap: 8px; margin-top: 10px; }
            .result-buttons button { font-size: 14px; padding: 8px; }

            .result-section-title { margin-top: 8px; margin-bottom: 4px; padding-left: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Giao diện chọn lớp -->
        <div id="grade-selection" class="grade-selection">
            <div class="header">
                <h1>ÔN TẬP GS TỪ VỰNG & NGỮ PHÁP (LỚP 4 - 9)</h1>
                <h2 id="grade-title">Chọn lớp</h2>
            </div>
            
            <div class="grade-buttons">
                <!-- Thêm lớp 4 và 5 ở trên -->
                <button id="grade4-btn">ÔN TẬP GS TỪ VỰNG & NGỮ PHÁP LỚP 4</button>
                <button id="grade5-btn">ÔN TẬP GS TỪ VỰNG & NGỮ PHÁP LỚP 5</button>
                <button id="grade6-btn">ÔN TẬP GS TỪ VỰNG & NGỮ PHÁP LỚP 6</button>
                <button id="grade7-btn">ÔN TẬP GS TỪ VỰNG & NGỮ PHÁP LỚP 7</button>
                <button id="grade8-btn">ÔN TẬP GS TỪ VỰNG & NGỮ PHÁP LỚP 8</button>
                <button id="grade9-btn">ÔN TẬP GS TỪ VỰNG & NGỮ PHÁP LỚP 9</button>
                <button id="contact-btn" class="back-button">LIÊN HỆ</button>
            </div>
        </div>

        <!-- Giao diện liên hệ -->
        <div id="contact-screen" class="main-menu hidden">
            <div class="header">
                <h1>THÔNG TIN LIÊN HỆ</h1>
                <h2>Giáo viên hỗ trợ</h2>
            </div>
            
            <div class="contact-info">
                <h3>Teacher Minho</h3>
                <p>Giáo viên tiếng Anh cấp 2,3 và ôn luyện đại học theo chuẩn IELTS, PTE</p>
                <p>
                    <svg class="social-icon" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M7,9.5C7,8.7 7.7,8 8.5,8C9.3,8 10,8.7 10,9.5C10,10.3 9.3,11 8.5,11C7.7,11 7,10.3 7,9.5M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23M15.5,11C14.7,11 14,10.3 14,9.5C14,8.7 14.7,8 15.5,8C16.3,8 17,8.7 17,9.5C17,10.3 16.3,11 15.5,11Z"/></svg>
                    Zalo: <a href="https://zalo.me/0933634766">0933.634.766</a>
                </p>
            </div>
            
            <div class="contact-info">
                <h3>Thầy Hùng</h3>
                <p>Giáo viên dạy kèm toán, tiếng Anh</p>
                <p>
                    <svg class="social-icon" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M7,9.5C7,8.7 7.7,8 8.5,8C9.3,8 10,8.7 10,9.5C10,10.3 9.3,11 8.5,11C7.7,11 7,10.3 7,9.5M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23M15.5,11C14.7,11 14,10.3 14,9.5C14,8.7 14.7,8 15.5,8C16.3,8 17,8.7 17,9.5C17,10.3 16.3,11 15.5,11Z"/></svg>
                    Zalo: <a href="https://zalo.me/0967095025">0967.095.025</a>
                </p>
            </div>
            
            <button id="back-from-contact-btn" class="back-button">Quay lại</button>
        </div>

        <!-- Giao diện 1: Màn hình chính -->
        <div id="main-menu" class="main-menu hidden">
            <div class="header">
                <h1 id="grade-header"></h1>
                <h2 id="unit-title">Chọn chế độ</h2>
            </div>
            
            <div class="menu-buttons">
                <button id="review-btn">ÔN TẬP TỪ VỰNG</button>
                <button id="practice-btn">TRẮC NGHIỆM TỪ VỰNG</button>
                <button id="grammar-btn" class="btn-grammar">BÀI TẬP NGỮ PHÁP</button>
                <button id="back-to-grade-btn" class="back-button">Quay lại chọn lớp</button>
            </div>
        </div>

        <!-- Giao diện 2: Màn hình ôn bài (Chỉ dùng cho Từ vựng) -->
        <div id="review-menu" class="review-menu hidden">
            <div class="header">
                <h1 id="review-grade-header"></h1>
                <h2 id="review-unit-title">Chọn đề bài ôn tập</h2>
            </div>
            
            <div class="form-group">
                <label for="review-unit-select">Chọn đề bài:</label>
                <!-- Sẽ được populate bằng JS -->
                <select id="review-unit-select"></select>
            </div>
            
            <button id="show-vocabulary-btn">ÔN TẬP TỪ VỰNG</button>
            <button id="auto-review-btn">ÔN BÀI TỰ ĐỘNG</button>
            <button id="back-to-main-btn" class="back-button">Quay lại</button>
        </div>

        <!-- Giao diện 3: Danh sách từ vựng -->
        <div id="vocabulary-list" class="vocabulary-list hidden">
            <div class="header">
                <h1 id="vocab-grade-header"></h1>
                <h2 id="vocabulary-unit-title"></h2>
            </div>
            
            <table class="vocabulary-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Từ vựng</th>
                        <th>(Từ loại) Nghĩa của từ</th>
                    </tr>
                </thead>
                <tbody id="vocabulary-table-body">
                </tbody>
            </table>
            <div class="button-container">
                <button id="back-to-review-btn" class="back-button">Quay lại</button>
            </div>
        </div>

        <!-- Màn hình ôn bài tự động -->
        <div id="auto-review-screen" class="auto-review-screen hidden">
            <div class="header">
                <h1 id="auto-review-grade-header"></h1>
                <h2 id="auto-review-unit-title"></h2>
            </div>
            
            <div class="word-container">
                <div id="auto-review-word" class="auto-review-word"></div>
                <button id="auto-review-speaker-btn" class="speaker-btn" title="Nghe phát âm">
                    <svg class="speaker-icon" viewBox="0 0 24 24"><path d="M3,9v6h4l5,5V4L7,9H3z M16.5,12c0-1.77-1.02-3.29-2.5-4.03v8.05C15.48,15.29,16.5,13.77,16.5,12z M14,3.23v2.06c2.89,.86,5,3.54,5,6.71s-2.11,5.85-5,6.71v2.06c4.01-.91,7-4.49,7-8.77S18.01,4.14,14,3.23z"/></svg>
                </button>
            </div>
            
            <div id="auto-review-meaning" class="auto-review-meaning"></div>
            
            <div class="auto-review-buttons hidden" id="auto-review-end-buttons">
                <button id="auto-review-again-btn">ÔN LẠI TỰ ĐỘNG</button>
                <button id="auto-review-back-btn" class="back-button">Quay lại</button>
            </div>
        </div>

        <!-- Màn hình đăng nhập (Dùng chung cho Vocab và Grammar) -->
        <div id="login-screen" class="login-screen hidden">
            <div class="header">
                <h1 id="login-grade-header"></h1>
                <h2 id="login-unit-title">Chọn đề bài làm bài</h2>
            </div>
            
            <div class="form-group">
                <label for="username">Nhập tên của bạn:</label>
                <input type="text" id="username" placeholder="Tên của bạn">
            </div>
            
            <div class="form-group">
                <label for="unit-select">Chọn đề bài:</label>
                <!-- Sẽ được populate bằng JS -->
                <select id="unit-select">
                    <option value="" disabled selected>HÃY CHỌN UNIT</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="question-count">Chọn số câu hỏi:</label>
                <select id="question-count">
                    <!-- Options sẽ được cập nhật động -->
                </select>
            </div>
            
            <div class="progress-container hidden" id="loading-container">
                <div class="progress-text">Đang tải dữ liệu...</div>
                <div class="progress-bar" id="loading-bar"></div>
            </div>
            
            <button id="start-btn">Bắt đầu</button>
            
            <div class="range-tests-container">
                <!-- Cập nhật lại các nút range test theo yêu cầu mới -->
                <div class="range-tests-row">
                    <button id="range-u1-u5-btn" class="btn-range-u1-u5">KIỂM TRA U1-U5</button>
                    <button id="range-u6-u10-btn" class="btn-range-u6-u10">KIỂM TRA U6-U10</button>
                </div>
                <div class="range-tests-row">
                    <button id="range-u1-u10-btn" class="btn-range-u1-u10">KIỂM TRA U1-U10</button>
                    <button id="range-u11-u15-btn" class="btn-range-u11-u15">KIỂM TRA U11-U15</button>
                </div>
                <div class="range-tests-row">
                    <button id="range-u16-u20-btn" class="btn-range-u16-u20">KIỂM TRA U16-U20</button>
                    <button id="range-u11-u20-btn" class="btn-range-u11-u20">KIỂM TRA U11-U20</button>
                </div>
            </div>

            <button id="comprehensive-test-btn" class="btn-comprehensive">KIỂM TRA TỔNG HỢP</button>
            <button id="back-to-main-from-login-btn" class="back-button">Quay lại</button>
        </div>

        <!-- Màn hình chơi (Dùng chung) -->
        <div id="quiz-screen" class="quiz-screen hidden">
            <div class="header">
                <h1 id="quiz-grade-header"></h1>
                <h2 id="quiz-unit-title"></h2>
            </div>
            
            <div class="timer-container">
                <div id="timer-bar" class="timer-bar"></div>
            </div>
            
            <div class="stats-container">
                <div id="question-counter" class="question-counter">Câu 1/30</div>
                <div id="streak" class="streak">Chuỗi đúng: 0</div>
            </div>
            
            <div class="question" id="question-text-label">Chọn nghĩa đúng cho từ sau:</div>
            
            <div class="word-container">
                <div id="word" class="word"></div>
                <!-- Nút loa: Ẩn trong chế độ Grammar -->
                <button id="speaker-btn" class="speaker-btn" title="Nghe phát âm">
                    <svg class="speaker-icon" viewBox="0 0 24 24"><path d="M3,9v6h4l5,5V4L7,9H3z M16.5,12c0-1.77-1.02-3.29-2.5-4.03v8.05C15.48,15.29,16.5,13.77,16.5,12z M14,3.23v2.06c2.89,.86,5,3.54,5,6.71s-2.11,5.85-5,6.71v2.06c4.01-.91,7-4.49,7-8.77S18.01,4.14,14,3.23z"/></svg>
                </button>
            </div>
            
            <div id="options" class="options"></div>
        </div>

        <!-- Màn hình kết quả -->
        <div id="result-screen" class="result-screen hidden">
            <div class="header">
                <h1 id="result-grade-header"></h1>
                <h2>Báo cáo chi tiết - <span id="result-unit-title"></span></h2>
            </div>

            <!-- Thông báo gian lận -->
            <div id="cheating-alert-box" class="cheating-alert">
                <h3>⚠️ CẢNH BÁO GIAN LẬN</h3>
                <p>Phát hiện bạn đã rời khỏi cửa sổ làm bài. Bài làm đã bị khóa và tự động nộp.</p>
            </div>
            
            <div class="dashboard-grid">
                <div class="main-result-card">
                    <div class="result-user-name" id="result-name">Tên học sinh</div>
                    
                    <div class="chart-container-wrapper">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path id="score-circle-path" class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#4CAF50" />
                            <text x="18" y="20.35" class="percentage-text" id="score-percentage-text">0%</text>
                        </svg>
                        
                        <div class="score-mini-info">
                            <!-- CHỈNH SỬA 3: XÓA CHỮ "ĐÚNG", CHỈ GIỮ LẠI SỐ -->
                            <span class="score-mini-text">
                                <span id="result-score-correct" class="score-mini-num">0</span> / <span id="result-score-total" class="score-mini-num">0</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="result-date-display">
                        <svg style="width:12px;height:12px;fill:#003366;vertical-align:middle;margin-right:3px;" viewBox="0 0 24 24"><path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"/></svg>
                        <span id="result-date-summary">Ngày: --/--/--</span>
                    </div>
                </div>

                <div class="stats-grid-card">
                    <div class="mini-stat-card time-start">
                        <svg class="mini-stat-icon" viewBox="0 0 24 24"><path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/></svg>
                        <span class="mini-stat-label">BẮT ĐẦU</span>
                        <span class="mini-stat-value" id="result-start-time">--:--</span>
                        <span class="mini-stat-sub" id="result-start-date">--/--</span>
                    </div>

                    <div class="mini-stat-card time-end">
                        <svg class="mini-stat-icon" viewBox="0 0 24 24"><path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M15,12V7H9V12H15M15,14V17H9V14H15Z"/></svg>
                        <span class="mini-stat-label">KẾT THÚC</span>
                        <span class="mini-stat-value" id="result-end-time">--:--</span>
                        <span class="mini-stat-sub" id="result-end-date">--/--</span>
                    </div>

                    <div class="mini-stat-card streak">
                        <svg class="mini-stat-icon" viewBox="0 0 24 24"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2M12 15.5L14.7 17.04L14.17 13.97L16.96 11.29L13.86 10.87L12.63 8L11.4 10.87L8.3 11.29L11.09 13.97L10.56 17.04L12 15.5Z"/></svg>
                        <span class="mini-stat-label">CHUỖI ĐÚNG</span>
                        <span class="mini-stat-value" id="result-max-streak">0</span>
                        <span class="mini-stat-sub">Câu liên tiếp</span>
                    </div>

                    <div class="mini-stat-card total-time">
                        <svg class="mini-stat-icon" viewBox="0 0 24 24"><path d="M12 20C16.4 20 20 16.4 20 12S16.4 4 12 4 4 7.6 4 12 7.6 20 12 20M12 2C17.5 2 22 6.5 22 12S17.5 22 12 22 2 17.5 2 12 6.5 2 12 2M12.5 7V12.25L17 14.92L16.25 16.15L11.5 13.75V7H12.5Z"/></svg>
                        <span class="mini-stat-label">TỔNG THỜI GIAN</span>
                        <span class="mini-stat-value" id="result-total-time">0s</span>
                        <span class="mini-stat-sub">Làm bài</span>
                    </div>
                </div>
            </div>
            
            <h3 class="result-section-title">Các câu trả lời sai</h3>
            <div id="wrong-questions" class="wrong-questions-list">
            </div>
            
            <h3 class="result-section-title">Lịch sử chi tiết</h3>
            <table id="answer-history" class="answer-history">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Từ/Câu hỏi</th>
                        <th>Đáp án chọn</th>
                        <th>Đáp án đúng</th>
                    </tr>
                </thead>
                <tbody id="answer-history-body">
                </tbody>
            </table>
            
            <div class="result-buttons">
                <button id="restart-btn">Làm lại</button>
                <button id="new-game-btn" class="btn-secondary">Chơi mới</button>
            </div>
            <button id="back-to-grade-from-result-btn" class="back-button">Quay lại chọn lớp</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <script>
        // ============================================================
        // 1. KHAI BÁO DỮ LIỆU TỪ VỰNG (VOCABULARY DATA)
        // ============================================================
        
        // --- LEVEL 4 VOCABULARY (Unit 1 - 20) ---
        const L4_U1_VOCAB_DATA = [
            { id: 1, word: "family", correct: "(n): gia đình", wrong1: "(v): đi", wrong2: "(adj): lớn", wrong3: "(n): trường học" },
            { id: 2, word: "father", correct: "(n): bố", wrong1: "(n): mẹ", wrong2: "(n): chị gái", wrong3: "(n): em trai" }
        ];
        const L4_U2_VOCAB_DATA = [];
        const L4_U3_VOCAB_DATA = [];
        const L4_U4_VOCAB_DATA = [];
        const L4_U5_VOCAB_DATA = [];
        const L4_U6_VOCAB_DATA = [];
        const L4_U7_VOCAB_DATA = [];
        const L4_U8_VOCAB_DATA = [];
        const L4_U9_VOCAB_DATA = [];
        const L4_U10_VOCAB_DATA = [];
        const L4_U11_VOCAB_DATA = [];
        const L4_U12_VOCAB_DATA = [];
        const L4_U13_VOCAB_DATA = [];
        const L4_U14_VOCAB_DATA = [];
        const L4_U15_VOCAB_DATA = [];
        const L4_U16_VOCAB_DATA = [];
        const L4_U17_VOCAB_DATA = [];
        const L4_U18_VOCAB_DATA = [];
        const L4_U19_VOCAB_DATA = [];
        const L4_U20_VOCAB_DATA = [];

        // --- LEVEL 5 VOCABULARY (Unit 1 - 20) ---
        const L5_U1_VOCAB_DATA = [
            { id: 1, word: "school", correct: "(n): trường học", wrong1: "(v): chơi", wrong2: "(adj): đẹp", wrong3: "(n): nhà" },
            { id: 2, word: "teacher", correct: "(n): giáo viên", wrong1: "(n): bác sĩ", wrong2: "(n): kỹ sư", wrong3: "(n): nông dân" }
        ];
        const L5_U2_VOCAB_DATA = [];
        const L5_U3_VOCAB_DATA = [];
        const L5_U4_VOCAB_DATA = [];
        const L5_U5_VOCAB_DATA = [];
        const L5_U6_VOCAB_DATA = [];
        const L5_U7_VOCAB_DATA = [];
        const L5_U8_VOCAB_DATA = [];
        const L5_U9_VOCAB_DATA = [];
        const L5_U10_VOCAB_DATA = [];
        const L5_U11_VOCAB_DATA = [];
        const L5_U12_VOCAB_DATA = [];
        const L5_U13_VOCAB_DATA = [];
        const L5_U14_VOCAB_DATA = [];
        const L5_U15_VOCAB_DATA = [];
        const L5_U16_VOCAB_DATA = [];
        const L5_U17_VOCAB_DATA = [];
        const L5_U18_VOCAB_DATA = [];
        const L5_U19_VOCAB_DATA = [];
        const L5_U20_VOCAB_DATA = [];

        // --- LEVEL 6 VOCABULARY (Giữ nguyên) ---
        const L6_U1_VOCAB_DATA = [
            { id: 1, word: "special", correct: "(adj): đặc biệt", wrong1: "(v): đến", wrong2: "(n): vườn", wrong3: "(n): lời khuyên" },
            { id: 2, word: "ready", correct: "(adj): sẵn sàng", wrong1: "(n): làng quê", wrong2: "(n): trường trung học", wrong3: "(n): bí mật" },
            { id: 3, word: "new", correct: "(adj): mới", wrong1: "(adv): gần", wrong2: "(n): những ngọn núi", wrong3: "(v): giúp" },
            { id: 4, word: "meet", correct: "(v): gặp", wrong1: "(v): đi bộ", wrong2: "(n): thư viện", wrong3: "(n): tiền" },
            { id: 5, word: "to live", correct: "(v): sống", wrong1: "(v): nhớ", wrong2: "(v): vẽ", wrong3: "(adj): yêu thích (nhất)" },
            { id: 6, word: "school", correct: "(n): trường", wrong1: "(n): điểm kiểm tra", wrong2: "(v): nghĩ", wrong3: "(adj): đói" },
            { id: 7, word: "heavy", correct: "(adj): nặng", wrong1: "(n): thị trấn", wrong2: "(v): học", wrong3: "(n): cuối tuần" },
            { id: 8, word: "smart", correct: "(adj): thông minh", wrong1: "(n): hồ bơi", wrong2: "(n): cái gọt bút chì", wrong3: "(n): câu lạc bộ" },
            { id: 9, word: "uniform", correct: "(n): đồng phục", wrong1: "(n): nhà kính", wrong2: "(v): cho mượn", wrong3: "(n): giấc mơ" },
            { id: 10, word: "subject", correct: "(n): môn học", wrong1: "(n): trang trại, nông trại", wrong2: "(n): thước kẻ, thước đo", wrong3: "(n): trường nội trú" },
            { id: 11, word: "wear", correct: "(v): mặc", wrong1: "(adj): đặc biệt", wrong2: "(v): đến", wrong3: "(n): vườn" },
            { id: 12, word: "history", correct: "(n): lịch sử", wrong1: "(adj): sẵn sàng", wrong2: "(n): làng quê", wrong3: "(n): trường trung học" },
            { id: 13, word: "calculator", correct: "(n): máy tính", wrong1: "(adj): mới", wrong2: "(adv): gần", wrong3: "(n): những ngọn núi" },
            { id: 14, word: "rubber", correct: "(n): cục tẩy", wrong1: "(v): gặp", wrong2: "(v): đi bộ", wrong3: "(n): thư viện" },
            { id: 15, word: "pencil case", correct: "(n): hộp bút", wrong1: "(v): sống", wrong2: "(v): nhớ", wrong3: "(v): vẽ" },
            { id: 16, word: "homework", correct: "(n): bài tập về nhà", wrong1: "(n): trường", wrong2: "(n): điểm kiểm tra", wrong3: "(v): nghĩ" },
            { id: 17, word: "football", correct: "(n): bóng đá", wrong1: "(adj): nặng", wrong2: "(n): thị trấn", wrong3: "(v): học" },
            { id: 18, word: "exercise", correct: "(n): bài thể dục", wrong1: "(adj): thông minh", wrong2: "(n): hồ bơi", wrong3: "(n): cái gọt bút chì" },
            { id: 19, word: "math", correct: "(n): toán", wrong1: "(n): đồng phục", wrong2: "(n): nhà kính", wrong3: "(v): cho mượn" },
            { id: 20, word: "science", correct: "(n): khoa học", wrong1: "(n): môn học", wrong2: "(n): trang trại, nông trại", wrong3: "(n): thước kẻ, thước đo" },
            { id: 21, word: "classroom", correct: "(n): phòng học", wrong1: "(v): mặc", wrong2: "(adj): đặc biệt", wrong3: "(v): đến" },
            { id: 22, word: "compass", correct: "(n): compa, dụng cụ vẽ hình tròn", wrong1: "(n): lịch sử", wrong2: "(adj): sẵn sàng", wrong3: "(n): làng quê" },
            { id: 23, word: "lesson", correct: "(n): bài học", wrong1: "(n): máy tính", wrong2: "(adj): mới", wrong3: "(adv): gần" },
            { id: 24, word: "playground", correct: "(n): sân chơi", wrong1: "(n): cục tẩy", wrong2: "(v): gặp", wrong3: "(v): đi bộ" },
            { id: 25, word: "ride", correct: "(v): cưỡi", wrong1: "(n): hộp bút", wrong2: "(v): sống", wrong3: "(v): nhớ" },
            { id: 26, word: "usually", correct: "(adv): thường xuyên", wrong1: "(n): bài tập về nhà", wrong2: "(n): trường", wrong3: "(n): điểm kiểm tra" },
            { id: 27, word: "rarely", correct: "(adv): hiếm khi", wrong1: "(n): bóng đá", wrong2: "(adj): nặng", wrong3: "(n): thị trấn" },
            { id: 28, word: "often", correct: "(adv): thường", wrong1: "(n): bài thể dục", wrong2: "(adj): thông minh", wrong3: "(n): hồ bơi" },
            { id: 29, word: "holiday", correct: "(n): ngày lễ, kì nghỉ", wrong1: "(n): toán", wrong2: "(n): đồng phục", wrong3: "(n): nhà kính" },
            { id: 30, word: "classmate", correct: "(n): bạn cùng lớp", wrong1: "(n): khoa học", wrong2: "(n): môn học", wrong3: "(n): trang trại, nông trại" },
            { id: 31, word: "advice", correct: "(n): lời khuyên", wrong1: "(n): phòng học", wrong2: "(v): mặc", wrong3: "(adj): đặc biệt" },
            { id: 32, word: "secret", correct: "(n): bí mật", wrong1: "(n): compa, dụng cụ vẽ hình tròn", wrong2: "(n): lịch sử", wrong3: "(adj): sẵn sàng" },
            { id: 33, word: "help", correct: "(v): giúp", wrong1: "(n): bài học", wrong2: "(n): máy tính", wrong3: "(adj): mới" },
            { id: 34, word: "money", correct: "(n): tiền", wrong1: "(n): sân chơi", wrong2: "(n): cục tẩy", wrong3: "(v): gặp" },
            { id: 35, word: "favorite", correct: "(adj): yêu thích (nhất)", wrong1: "(v): cưỡi", wrong2: "(n): hộp bút", wrong3: "(v): sống" },
            { id: 36, word: "hungry", correct: "(adj): đói", wrong1: "(adv): thường xuyên", wrong2: "(n): bài tập về nhà", wrong3: "(n): trường" },
            { id: 37, word: "weekend", correct: "(n): cuối tuần", wrong1: "(adv): hiếm khi", wrong2: "(n): bóng đá", wrong3: "(adj): nặng" },
            { id: 38, word: "club", correct: "(n): câu lạc bộ", wrong1: "(adv): thường", wrong2: "(n): bài thể dục", wrong3: "(adj): thông minh" },
            { id: 39, word: "dream", correct: "(n): giấc mơ", wrong1: "(n): ngày lễ, kì nghỉ", wrong2: "(n): toán", wrong3: "(n): đồng phục" },
            { id: 40, word: "boarding school", correct: "(n): trường nội trú", wrong1: "(n): bạn cùng lớp", wrong2: "(n): khoa học", wrong3: "(n): môn học" },
            { id: 41, word: "garden", correct: "(n): vườn", wrong1: "(n): lời khuyên", wrong2: "(n): phòng học", wrong3: "(v): mặc" },
            { id: 42, word: "secondary school", correct: "(n): trường trung học", wrong1: "(n): bí mật", wrong2: "(n): compa, dụng cụ vẽ hình tròn", wrong3: "(n): lịch sử" },
            { id: 43, word: "mountains", correct: "(n): những ngọn núi", wrong1: "(v): giúp", wrong2: "(n): bài học", wrong3: "(n): máy tính" },
            { id: 44, word: "library", correct: "(n): thư viện", wrong1: "(n): tiền", wrong2: "(n): sân chơi", wrong3: "(n): cục tẩy" },
            { id: 45, word: "paint", correct: "(v): vẽ", wrong1: "(adj): yêu thích (nhất)", wrong2: "(v): cưỡi", wrong3: "(n): hộp bút" },
            { id: 46, word: "think", correct: "(v): nghĩ", wrong1: "(adj): đói", wrong2: "(adv): thường xuyên", wrong3: "(n): bài tập về nhà" },
            { id: 47, word: "learn", correct: "(v): học", wrong1: "(n): cuối tuần", wrong2: "(adv): hiếm khi", wrong3: "(n): bóng đá" },
            { id: 48, word: "sharpener", correct: "(n): cái gọt bút chì", wrong1: "(n): câu lạc bộ", wrong2: "(adv): thường", wrong3: "(n): bài thể dục" },
            { id: 49, word: "lend", correct: "(v): cho mượn", wrong1: "(n): giấc mơ", wrong2: "(n): ngày lễ, kì nghỉ", wrong3: "(n): toán" },
            { id: 50, word: "ruler", correct: "(n): thước kẻ, thước đo", wrong1: "(n): trường nội trú", wrong2: "(n): bạn cùng lớp", wrong3: "(n): khoa học" },
            { id: 51, word: "come", correct: "(v): đến", wrong1: "(n): vườn", wrong2: "(n): lời khuyên", wrong3: "(n): phòng học" },
            { id: 52, word: "village", correct: "(n): làng quê", wrong1: "(n): trường trung học", wrong2: "(n): bí mật", wrong3: "(n): compa, dụng cụ vẽ hình tròn" },
            { id: 53, word: "near", correct: "(adv): gần", wrong1: "(n): những ngọn núi", wrong2: "(v): giúp", wrong3: "(n): bài học" },
            { id: 54, word: "walk", correct: "(v): đi bộ", wrong1: "(n): thư viện", wrong2: "(n): tiền", wrong3: "(n): sân chơi" },
            { id: 55, word: "remember", correct: "(v): nhớ", wrong1: "(v): vẽ", wrong2: "(adj): yêu thích (nhất)", wrong3: "(v): cưỡi" },
            { id: 56, word: "mark", correct: "(n): điểm kiểm tra", wrong1: "(v): nghĩ", wrong2: "(adj): đói", wrong3: "(adv): thường xuyên" },
            { id: 57, word: "town", correct: "(n): thị trấn", wrong1: "(v): học", wrong2: "(n): cuối tuần", wrong3: "(adv): hiếm khi" },
            { id: 58, word: "swimming pool", correct: "(n): hồ bơi", wrong1: "(n): cái gọt bút chì", wrong2: "(n): câu lạc bộ", wrong3: "(adv): thường" },
            { id: 59, word: "greenhouse", correct: "(n): nhà kính", wrong1: "(v): cho mượn", wrong2: "(n): giấc mơ", wrong3: "(n): ngày lễ, kì nghỉ" },
            { id: 60, word: "farm", correct: "(n): trang trại, nông trại", wrong1: "(n): thước kẻ, thước đo", wrong2: "(n): trường nội trú", wrong3: "(n): bạn cùng lớp" }
        ];

        const L6_U2_VOCAB_DATA = [{ id: 1, word: "room", correct: "(n): phòng", wrong1: "(n): tủ quần áo", wrong2: "(n): đồng hồ", wrong3: "(n): mẹ" }];
        const L6_U3_VOCAB_DATA = [{ id: 1, word: "idea", correct: "(n): ý tưởng", wrong1: "(n): mọi thứ", wrong2: "(adj): thấp, ngắn", wrong3: "(n): thư" }];
        const L6_U4_VOCAB_DATA = [{ id: 1, word: "L6_U4_Vocab_Word_1", correct: "(n): Nghĩa từ 4.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];
        const L6_U5_VOCAB_DATA = [{ id: 1, word: "L6_U5_Vocab_Word_1", correct: "(n): Nghĩa từ 5.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];
        const L6_U6_VOCAB_DATA = [{ id: 1, word: "L6_U6_Vocab_Word_1", correct: "(n): Nghĩa từ 6.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];
        const L6_U7_VOCAB_DATA = [{ id: 1, word: "L6_U7_Vocab_Word_1", correct: "(n): Nghĩa từ 7.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];
        const L6_U8_VOCAB_DATA = [{ id: 1, word: "L6_U8_Vocab_Word_1", correct: "(n): Nghĩa từ 8.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];
        const L6_U9_VOCAB_DATA = [{ id: 1, word: "L6_U9_Vocab_Word_1", correct: "(n): Nghĩa từ 9.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];
        const L6_U10_VOCAB_DATA = [{ id: 1, word: "L6_U10_Vocab_Word_1", correct: "(n): Nghĩa từ 10.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];
        const L6_U11_VOCAB_DATA = [{ id: 1, word: "L6_U11_Vocab_Word_1", correct: "(n): Nghĩa từ 11.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];
        const L6_U12_VOCAB_DATA = [{ id: 1, word: "L6_U12_Vocab_Word_1", correct: "(n): Nghĩa từ 12.1", wrong1: "(v): Sai 1", wrong2: "(adj): Sai 2", wrong3: "(n): Sai 3" }];


        // --- LEVEL 7-9 VOCABULARY (PLACEHOLDERS) ---
        const L7_U1_VOCAB_DATA = []; const L7_U2_VOCAB_DATA = []; const L7_U3_VOCAB_DATA = []; const L7_U4_VOCAB_DATA = []; const L7_U5_VOCAB_DATA = []; const L7_U6_VOCAB_DATA = []; const L7_U7_VOCAB_DATA = []; const L7_U8_VOCAB_DATA = []; const L7_U9_VOCAB_DATA = []; const L7_U10_VOCAB_DATA = []; const L7_U11_VOCAB_DATA = []; const L7_U12_VOCAB_DATA = [];
        const L8_U1_VOCAB_DATA = []; const L8_U2_VOCAB_DATA = []; const L8_U3_VOCAB_DATA = []; const L8_U4_VOCAB_DATA = []; const L8_U5_VOCAB_DATA = []; const L8_U6_VOCAB_DATA = []; const L8_U7_VOCAB_DATA = []; const L8_U8_VOCAB_DATA = []; const L8_U9_VOCAB_DATA = []; const L8_U10_VOCAB_DATA = []; const L8_U11_VOCAB_DATA = []; const L8_U12_VOCAB_DATA = [];
        const L9_U1_VOCAB_DATA = []; const L9_U2_VOCAB_DATA = []; const L9_U3_VOCAB_DATA = []; const L9_U4_VOCAB_DATA = []; const L9_U5_VOCAB_DATA = []; const L9_U6_VOCAB_DATA = []; const L9_U7_VOCAB_DATA = []; const L9_U8_VOCAB_DATA = []; const L9_U9_VOCAB_DATA = []; const L9_U10_VOCAB_DATA = []; const L9_U11_VOCAB_DATA = []; const L9_U12_VOCAB_DATA = [];


        // ============================================================
        // 2. KHAI BÁO DỮ LIỆU NGỮ PHÁP (GRAMMAR DATA)
        // ============================================================

        // --- LEVEL 4 GRAMMAR (Unit 1 - 20) ---
        const L4_U1_GRAMMAR_DATA = [
            { id: 1, word: "I _____ a student.", correct: "am", wrong1: "is", wrong2: "are", wrong3: "be" },
            { id: 2, word: "She _____ my friend.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" }
        ];
        const L4_U2_GRAMMAR_DATA = []; const L4_U3_GRAMMAR_DATA = []; const L4_U4_GRAMMAR_DATA = []; const L4_U5_GRAMMAR_DATA = [];
        const L4_U6_GRAMMAR_DATA = []; const L4_U7_GRAMMAR_DATA = []; const L4_U8_GRAMMAR_DATA = []; const L4_U9_GRAMMAR_DATA = []; const L4_U10_GRAMMAR_DATA = [];
        const L4_U11_GRAMMAR_DATA = []; const L4_U12_GRAMMAR_DATA = []; const L4_U13_GRAMMAR_DATA = []; const L4_U14_GRAMMAR_DATA = []; const L4_U15_GRAMMAR_DATA = [];
        const L4_U16_GRAMMAR_DATA = []; const L4_U17_GRAMMAR_DATA = []; const L4_U18_GRAMMAR_DATA = []; const L4_U19_GRAMMAR_DATA = []; const L4_U20_GRAMMAR_DATA = [];

        // --- LEVEL 5 GRAMMAR (Unit 1 - 20) ---
        const L5_U1_GRAMMAR_DATA = [
            { id: 1, word: "What _____ this?", correct: "is", wrong1: "am", wrong2: "are", wrong3: "do" },
            { id: 2, word: "They _____ happy.", correct: "are", wrong1: "am", wrong2: "is", wrong3: "be" }
        ];
        const L5_U2_GRAMMAR_DATA = []; const L5_U3_GRAMMAR_DATA = []; const L5_U4_GRAMMAR_DATA = []; const L5_U5_GRAMMAR_DATA = [];
        const L5_U6_GRAMMAR_DATA = []; const L5_U7_GRAMMAR_DATA = []; const L5_U8_GRAMMAR_DATA = []; const L5_U9_GRAMMAR_DATA = []; const L5_U10_GRAMMAR_DATA = [];
        const L5_U11_GRAMMAR_DATA = []; const L5_U12_GRAMMAR_DATA = []; const L5_U13_GRAMMAR_DATA = []; const L5_U14_GRAMMAR_DATA = []; const L5_U15_GRAMMAR_DATA = [];
        const L5_U16_GRAMMAR_DATA = []; const L5_U17_GRAMMAR_DATA = []; const L5_U18_GRAMMAR_DATA = []; const L5_U19_GRAMMAR_DATA = []; const L5_U20_GRAMMAR_DATA = [];

        // --- LEVEL 6 GRAMMAR (Giữ nguyên) ---
        const L6_U1_GRAMMAR_DATA = [
            { id: 1, word: "I _____ a student.", correct: "am", wrong1: "is", wrong2: "are", wrong3: "be" },
            { id: 2, word: "She _____ my friend.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 3, word: "They _____ teachers.", correct: "are", wrong1: "am", wrong2: "is", wrong3: "be" },
            { id: 4, word: "He _____ happy.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 5, word: "We _____ in classroom.", correct: "are", wrong1: "am", wrong2: "is", wrong3: "be" },
            { id: 6, word: "It _____ a cat.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 7, word: "You _____ late.", correct: "are", wrong1: "am", wrong2: "is", wrong3: "be" },
            { id: 8, word: "My mother _____ at home.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 9, word: "Tom and Jerry _____ friends.", correct: "are", wrong1: "am", wrong2: "is", wrong3: "be" },
            { id: 10, word: "I _____ not hungry.", correct: "am", wrong1: "is", wrong2: "are", wrong3: "do" },
            { id: 11, word: "_____ she nice?", correct: "Is", wrong1: "Am", wrong2: "Are", wrong3: "Do" },
            { id: 12, word: "_____ you okay?", correct: "Are", wrong1: "Am", wrong2: "Is", wrong3: "Do" },
            { id: 13, word: "_____ he tall?", correct: "Is", wrong1: "Am", wrong2: "Are", wrong3: "Do" },
            { id: 14, word: "_____ they students?", correct: "Are", wrong1: "Am", wrong2: "Is", wrong3: "Do" },
            { id: 15, word: "No, I _____ not.", correct: "am", wrong1: "is", wrong2: "are", wrong3: "do" },
            { id: 16, word: "Yes, she _____.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "does" },
            { id: 17, word: "This _____ my book.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 18, word: "That _____ a pen.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 19, word: "These _____ apples.", correct: "are", wrong1: "am", wrong2: "is", wrong3: "be" },
            { id: 20, word: "Those _____ chairs.", correct: "are", wrong1: "am", wrong2: "is", wrong3: "be" },
            { id: 21, word: "There _____ a table in room.", correct: "is", wrong1: "are", wrong2: "am", wrong3: "be" },
            { id: 22, word: "There _____ two chairs there.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 23, word: "_____ there a lamp?", correct: "Is", wrong1: "Are", wrong2: "Am", wrong3: "Do" },
            { id: 24, word: "_____ there any books?", correct: "Are", wrong1: "Is", wrong2: "Am", wrong3: "Do" },
            { id: 25, word: "My name _____ Minh.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 26, word: "What _____ this?", correct: "is", wrong1: "am", wrong2: "are", wrong3: "do" },
            { id: 27, word: "Where _____ you from?", correct: "are", wrong1: "is", wrong2: "am", wrong3: "do" },
            { id: 28, word: "How old _____ she?", correct: "is", wrong1: "are", wrong2: "am", wrong3: "do" },
            { id: 29, word: "It _____ sunny today.", correct: "is", wrong1: "are", wrong2: "am", wrong3: "be" },
            { id: 30, word: "We _____ friends.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 31, word: "I _____ a teacher.", correct: "am", wrong1: "is", wrong2: "are", wrong3: "be" },
            { id: 32, word: "He _____ a doctor.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 33, word: "They _____ students.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 34, word: "She _____ beautiful.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 35, word: "You _____ tall.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 36, word: "My father _____ at work.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 37, word: "The cats _____ cute.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 38, word: "The dog _____ big.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 39, word: "I _____ happy.", correct: "am", wrong1: "is", wrong2: "are", wrong3: "be" },
            { id: 40, word: "We _____ sad.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 41, word: "He _____ tired.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 42, word: "She _____ hungry.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 43, word: "You _____ thirsty.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 44, word: "They _____ angry.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 45, word: "It _____ cold.", correct: "is", wrong1: "am", wrong2: "are", wrong3: "be" },
            { id: 46, word: "_____ he a teacher?", correct: "Is", wrong1: "Are", wrong2: "Am", wrong3: "Do" },
            { id: 47, word: "_____ they doctors?", correct: "Are", wrong1: "Is", wrong2: "Am", wrong3: "Do" },
            { id: 48, word: "_____ you a student?", correct: "Are", wrong1: "Is", wrong2: "Am", wrong3: "Do" },
            { id: 49, word: "_____ I late?", correct: "Am", wrong1: "Is", wrong2: "Are", wrong3: "Do" },
            { id: 50, word: "_____ it a bird?", correct: "Is", wrong1: "Are", wrong2: "Am", wrong3: "Do" },
            { id: 51, word: "These books _____ new.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 52, word: "That car _____ red.", correct: "is", wrong1: "are", wrong2: "am", wrong3: "be" },
            { id: 53, word: "Those houses _____ big.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 54, word: "This bag _____ heavy.", correct: "is", wrong1: "are", wrong2: "am", wrong3: "be" },
            { id: 55, word: "There _____ a ruler on desk.", correct: "is", wrong1: "are", wrong2: "am", wrong3: "be" },
            { id: 56, word: "There _____ many students in class.", correct: "are", wrong1: "is", wrong2: "am", wrong3: "be" },
            { id: 57, word: "There _____ some water in glass.", correct: "is", wrong1: "are", wrong2: "am", wrong3: "be" },
            { id: 58, word: "_____ there any milk?", correct: "Is", wrong1: "Are", wrong2: "Am", wrong3: "Do" },
            { id: 59, word: "_____ there any eggs?", correct: "Are", wrong1: "Is", wrong2: "Am", wrong3: "Do" },
            { id: 60, word: "My sister _____ 10 years old.", correct: "is", wrong1: "are", wrong2: "am", wrong3: "be" }
        ];

        const L6_U2_GRAMMAR_DATA = [{ id: 1, word: "L6_U2_Grammar_Q1", correct: "Correct Ans", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U3_GRAMMAR_DATA = [{ id: 1, word: "L6_U3_Grammar_Q1", correct: "Correct Ans", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U4_GRAMMAR_DATA = [{ id: 1, word: "L6_U4_Grammar_1", correct: "Correct Ans 1.4", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U5_GRAMMAR_DATA = [{ id: 1, word: "L6_U5_Grammar_1", correct: "Correct Ans 1.5", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U6_GRAMMAR_DATA = [{ id: 1, word: "L6_U6_Grammar_1", correct: "Correct Ans 1.6", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U7_GRAMMAR_DATA = [{ id: 1, word: "L6_U7_Grammar_1", correct: "Correct Ans 1.7", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U8_GRAMMAR_DATA = [{ id: 1, word: "L6_U8_Grammar_1", correct: "Correct Ans 1.8", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U9_GRAMMAR_DATA = [{ id: 1, word: "L6_U9_Grammar_1", correct: "Correct Ans 1.9", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U10_GRAMMAR_DATA = [{ id: 1, word: "L6_U10_Grammar_1", correct: "Correct Ans 1.10", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U11_GRAMMAR_DATA = [{ id: 1, word: "L6_U11_Grammar_1", correct: "Correct Ans 1.11", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];
        const L6_U12_GRAMMAR_DATA = [{ id: 1, word: "L6_U12_Grammar_1", correct: "Correct Ans 1.12", wrong1: "Wrong 1", wrong2: "Wrong 2", wrong3: "Wrong 3" }];


        // --- LEVEL 7-9 GRAMMAR (PLACEHOLDERS) ---
        const L7_U1_GRAMMAR_DATA = []; const L7_U2_GRAMMAR_DATA = []; const L7_U3_GRAMMAR_DATA = []; const L7_U4_GRAMMAR_DATA = []; const L7_U5_GRAMMAR_DATA = []; const L7_U6_GRAMMAR_DATA = []; const L7_U7_GRAMMAR_DATA = []; const L7_U8_GRAMMAR_DATA = []; const L7_U9_GRAMMAR_DATA = []; const L7_U10_GRAMMAR_DATA = []; const L7_U11_GRAMMAR_DATA = []; const L7_U12_GRAMMAR_DATA = [];
        const L8_U1_GRAMMAR_DATA = []; const L8_U2_GRAMMAR_DATA = []; const L8_U3_GRAMMAR_DATA = []; const L8_U4_GRAMMAR_DATA = []; const L8_U5_GRAMMAR_DATA = []; const L8_U6_GRAMMAR_DATA = []; const L8_U7_GRAMMAR_DATA = []; const L8_U8_GRAMMAR_DATA = []; const L8_U9_GRAMMAR_DATA = []; const L8_U10_GRAMMAR_DATA = []; const L8_U11_GRAMMAR_DATA = []; const L8_U12_GRAMMAR_DATA = [];
        const L9_U1_GRAMMAR_DATA = []; const L9_U2_GRAMMAR_DATA = []; const L9_U3_GRAMMAR_DATA = []; const L9_U4_GRAMMAR_DATA = []; const L9_U5_GRAMMAR_DATA = []; const L9_U6_GRAMMAR_DATA = []; const L9_U7_GRAMMAR_DATA = []; const L9_U8_GRAMMAR_DATA = []; const L9_U9_GRAMMAR_DATA = []; const L9_U10_GRAMMAR_DATA = []; const L9_U11_GRAMMAR_DATA = []; const L9_U12_GRAMMAR_DATA = [];


        // ============================================================
        // 3. CẤU TRÚC DỮ LIỆU CHÍNH (DATA STRUCTURE)
        // ============================================================

        const gradeData = {
            "E4": {
                units: {
                    "UNIT 1": L4_U1_VOCAB_DATA, "UNIT 2": L4_U2_VOCAB_DATA, "UNIT 3": L4_U3_VOCAB_DATA, "UNIT 4": L4_U4_VOCAB_DATA, "UNIT 5": L4_U5_VOCAB_DATA,
                    "UNIT 6": L4_U6_VOCAB_DATA, "UNIT 7": L4_U7_VOCAB_DATA, "UNIT 8": L4_U8_VOCAB_DATA, "UNIT 9": L4_U9_VOCAB_DATA, "UNIT 10": L4_U10_VOCAB_DATA,
                    "UNIT 11": L4_U11_VOCAB_DATA, "UNIT 12": L4_U12_VOCAB_DATA, "UNIT 13": L4_U13_VOCAB_DATA, "UNIT 14": L4_U14_VOCAB_DATA, "UNIT 15": L4_U15_VOCAB_DATA,
                    "UNIT 16": L4_U16_VOCAB_DATA, "UNIT 17": L4_U17_VOCAB_DATA, "UNIT 18": L4_U18_VOCAB_DATA, "UNIT 19": L4_U19_VOCAB_DATA, "UNIT 20": L4_U20_VOCAB_DATA
                }
            },
            "E5": {
                units: {
                    "UNIT 1": L5_U1_VOCAB_DATA, "UNIT 2": L5_U2_VOCAB_DATA, "UNIT 3": L5_U3_VOCAB_DATA, "UNIT 4": L5_U4_VOCAB_DATA, "UNIT 5": L5_U5_VOCAB_DATA,
                    "UNIT 6": L5_U6_VOCAB_DATA, "UNIT 7": L5_U7_VOCAB_DATA, "UNIT 8": L5_U8_VOCAB_DATA, "UNIT 9": L5_U9_VOCAB_DATA, "UNIT 10": L5_U10_VOCAB_DATA,
                    "UNIT 11": L5_U11_VOCAB_DATA, "UNIT 12": L5_U12_VOCAB_DATA, "UNIT 13": L5_U13_VOCAB_DATA, "UNIT 14": L5_U14_VOCAB_DATA, "UNIT 15": L5_U15_VOCAB_DATA,
                    "UNIT 16": L5_U16_VOCAB_DATA, "UNIT 17": L5_U17_VOCAB_DATA, "UNIT 18": L5_U18_VOCAB_DATA, "UNIT 19": L5_U19_VOCAB_DATA, "UNIT 20": L5_U20_VOCAB_DATA
                }
            },
            "E6": {
                units: {
                    "UNIT 1": L6_U1_VOCAB_DATA, "UNIT 2": L6_U2_VOCAB_DATA, "UNIT 3": L6_U3_VOCAB_DATA, "UNIT 4": L6_U4_VOCAB_DATA, "UNIT 5": L6_U5_VOCAB_DATA,
                    "UNIT 6": L6_U6_VOCAB_DATA, "UNIT 7": L6_U7_VOCAB_DATA, "UNIT 8": L6_U8_VOCAB_DATA, "UNIT 9": L6_U9_VOCAB_DATA, "UNIT 10": L6_U10_VOCAB_DATA,
                    "UNIT 11": L6_U11_VOCAB_DATA, "UNIT 12": L6_U12_VOCAB_DATA
                }
            },
            "E7": {
                units: {
                    "UNIT 1": L7_U1_VOCAB_DATA, "UNIT 2": L7_U2_VOCAB_DATA, "UNIT 3": L7_U3_VOCAB_DATA, "UNIT 4": L7_U4_VOCAB_DATA, "UNIT 5": L7_U5_VOCAB_DATA,
                    "UNIT 6": L7_U6_VOCAB_DATA, "UNIT 7": L7_U7_VOCAB_DATA, "UNIT 8": L7_U8_VOCAB_DATA, "UNIT 9": L7_U9_VOCAB_DATA, "UNIT 10": L7_U10_VOCAB_DATA,
                    "UNIT 11": L7_U11_VOCAB_DATA, "UNIT 12": L7_U12_VOCAB_DATA
                }
            },
            "E8": {
                units: {
                    "UNIT 1": L8_U1_VOCAB_DATA, "UNIT 2": L8_U2_VOCAB_DATA, "UNIT 3": L8_U3_VOCAB_DATA, "UNIT 4": L8_U4_VOCAB_DATA, "UNIT 5": L8_U5_VOCAB_DATA,
                    "UNIT 6": L8_U6_VOCAB_DATA, "UNIT 7": L8_U7_VOCAB_DATA, "UNIT 8": L8_U8_VOCAB_DATA, "UNIT 9": L8_U9_VOCAB_DATA, "UNIT 10": L8_U10_VOCAB_DATA,
                    "UNIT 11": L8_U11_VOCAB_DATA, "UNIT 12": L8_U12_VOCAB_DATA
                }
            },
            "E9": {
                units: {
                    "UNIT 1": L9_U1_VOCAB_DATA, "UNIT 2": L9_U2_VOCAB_DATA, "UNIT 3": L9_U3_VOCAB_DATA, "UNIT 4": L9_U4_VOCAB_DATA, "UNIT 5": L9_U5_VOCAB_DATA,
                    "UNIT 6": L9_U6_VOCAB_DATA, "UNIT 7": L9_U7_VOCAB_DATA, "UNIT 8": L9_U8_VOCAB_DATA, "UNIT 9": L9_U9_VOCAB_DATA, "UNIT 10": L9_U10_VOCAB_DATA,
                    "UNIT 11": L9_U11_VOCAB_DATA, "UNIT 12": L9_U12_VOCAB_DATA
                }
            }
        };

        const grammarData = {
            "E4": {
                units: {
                    "UNIT 1": L4_U1_GRAMMAR_DATA, "UNIT 2": L4_U2_GRAMMAR_DATA, "UNIT 3": L4_U3_GRAMMAR_DATA, "UNIT 4": L4_U4_GRAMMAR_DATA, "UNIT 5": L4_U5_GRAMMAR_DATA,
                    "UNIT 6": L4_U6_GRAMMAR_DATA, "UNIT 7": L4_U7_GRAMMAR_DATA, "UNIT 8": L4_U8_GRAMMAR_DATA, "UNIT 9": L4_U9_GRAMMAR_DATA, "UNIT 10": L4_U10_GRAMMAR_DATA,
                    "UNIT 11": L4_U11_GRAMMAR_DATA, "UNIT 12": L4_U12_GRAMMAR_DATA, "UNIT 13": L4_U13_GRAMMAR_DATA, "UNIT 14": L4_U14_GRAMMAR_DATA, "UNIT 15": L4_U15_GRAMMAR_DATA,
                    "UNIT 16": L4_U16_GRAMMAR_DATA, "UNIT 17": L4_U17_GRAMMAR_DATA, "UNIT 18": L4_U18_GRAMMAR_DATA, "UNIT 19": L4_U19_GRAMMAR_DATA, "UNIT 20": L4_U20_GRAMMAR_DATA
                }
            },
            "E5": {
                units: {
                    "UNIT 1": L5_U1_GRAMMAR_DATA, "UNIT 2": L5_U2_GRAMMAR_DATA, "UNIT 3": L5_U3_GRAMMAR_DATA, "UNIT 4": L5_U4_GRAMMAR_DATA, "UNIT 5": L5_U5_GRAMMAR_DATA,
                    "UNIT 6": L5_U6_GRAMMAR_DATA, "UNIT 7": L5_U7_GRAMMAR_DATA, "UNIT 8": L5_U8_GRAMMAR_DATA, "UNIT 9": L5_U9_GRAMMAR_DATA, "UNIT 10": L5_U10_GRAMMAR_DATA,
                    "UNIT 11": L5_U11_GRAMMAR_DATA, "UNIT 12": L5_U12_GRAMMAR_DATA, "UNIT 13": L5_U13_GRAMMAR_DATA, "UNIT 14": L5_U14_GRAMMAR_DATA, "UNIT 15": L5_U15_GRAMMAR_DATA,
                    "UNIT 16": L5_U16_GRAMMAR_DATA, "UNIT 17": L5_U17_GRAMMAR_DATA, "UNIT 18": L5_U18_GRAMMAR_DATA, "UNIT 19": L5_U19_GRAMMAR_DATA, "UNIT 20": L5_U20_GRAMMAR_DATA
                }
            },
            "E6": {
                units: {
                    "UNIT 1": L6_U1_GRAMMAR_DATA, "UNIT 2": L6_U2_GRAMMAR_DATA, "UNIT 3": L6_U3_GRAMMAR_DATA, "UNIT 4": L6_U4_GRAMMAR_DATA, "UNIT 5": L6_U5_GRAMMAR_DATA,
                    "UNIT 6": L6_U6_GRAMMAR_DATA, "UNIT 7": L6_U7_GRAMMAR_DATA, "UNIT 8": L6_U8_GRAMMAR_DATA, "UNIT 9": L6_U9_GRAMMAR_DATA, "UNIT 10": L6_U10_GRAMMAR_DATA,
                    "UNIT 11": L6_U11_GRAMMAR_DATA, "UNIT 12": L6_U12_GRAMMAR_DATA
                }
            },
            "E7": {
                units: {
                    "UNIT 1": L7_U1_GRAMMAR_DATA, "UNIT 2": L7_U2_GRAMMAR_DATA, "UNIT 3": L7_U3_GRAMMAR_DATA, "UNIT 4": L7_U4_GRAMMAR_DATA, "UNIT 5": L7_U5_GRAMMAR_DATA,
                    "UNIT 6": L7_U6_GRAMMAR_DATA, "UNIT 7": L7_U7_GRAMMAR_DATA, "UNIT 8": L7_U8_GRAMMAR_DATA, "UNIT 9": L7_U9_GRAMMAR_DATA, "UNIT 10": L7_U10_GRAMMAR_DATA,
                    "UNIT 11": L7_U11_GRAMMAR_DATA, "UNIT 12": L7_U12_GRAMMAR_DATA
                }
            },
            "E8": {
                units: {
                    "UNIT 1": L8_U1_GRAMMAR_DATA, "UNIT 2": L8_U2_GRAMMAR_DATA, "UNIT 3": L8_U3_GRAMMAR_DATA, "UNIT 4": L8_U4_GRAMMAR_DATA, "UNIT 5": L8_U5_GRAMMAR_DATA,
                    "UNIT 6": L8_U6_GRAMMAR_DATA, "UNIT 7": L8_U7_GRAMMAR_DATA, "UNIT 8": L8_U8_GRAMMAR_DATA, "UNIT 9": L8_U9_GRAMMAR_DATA, "UNIT 10": L8_U10_GRAMMAR_DATA,
                    "UNIT 11": L8_U11_GRAMMAR_DATA, "UNIT 12": L8_U12_GRAMMAR_DATA
                }
            },
            "E9": {
                units: {
                    "UNIT 1": L9_U1_GRAMMAR_DATA, "UNIT 2": L9_U2_GRAMMAR_DATA, "UNIT 3": L9_U3_GRAMMAR_DATA, "UNIT 4": L9_U4_GRAMMAR_DATA, "UNIT 5": L9_U5_GRAMMAR_DATA,
                    "UNIT 6": L9_U6_GRAMMAR_DATA, "UNIT 7": L9_U7_GRAMMAR_DATA, "UNIT 8": L9_U8_GRAMMAR_DATA, "UNIT 9": L9_U9_GRAMMAR_DATA, "UNIT 10": L9_U10_GRAMMAR_DATA,
                    "UNIT 11": L9_U11_GRAMMAR_DATA, "UNIT 12": L9_U12_GRAMMAR_DATA
                }
            }
        };

        // ============================================================
        // 4. LOGIC XỬ LÝ CHÍNH (GAME LOGIC)
        // ============================================================
        
        // Biến toàn cục
        let currentQuestionIndex = 0;
        let score = 0;
        let streak = 0;
        let maxStreak = 0;
        let timer;
        let timeLeft;
        let totalTime = 0;
        let questionTimes = [];
        let selectedQuestions = [];
        let username = "";
        let wrongQuestions = [];
        let answerHistory = [];
        let selectedOptions = [];
        let startTime;
        let endTime;
        let currentWord = "";
        let questionCount = 30;
        let currentUnit = ""; 
        let currentGrade = "";
        let currentTestTitle = "";
        let maxUnits = 12; // Mặc định (sẽ thay đổi khi chọn lớp 4,5)
        
        // Biến mode: 'vocab' hoặc 'grammar'
        let currentMode = 'vocab'; 
        
        // Biến cho chức năng ôn bài tự động
        let autoReviewIndex = 0;
        let autoReviewTimer;
        let autoReviewQuestions = [];
        let autoReviewSpeakTimer1;
        let autoReviewSpeakTimer2;
        
        // Biến cho chức năng kiểm tra tổng hợp
        let comprehensivePool = [];
        let isComprehensiveTest = false;

        // --- BIẾN MỚI: CHỐNG GIAN LẬN ---
        let isCheatingDetected = false;
        let transitionTimeout = null; // Để hủy delay chuyển câu nếu bị bắt gian lận

        // DOM elements
        const gradeSelection = document.getElementById('grade-selection');
        const mainMenu = document.getElementById('main-menu');
        const contactBtn = document.getElementById('contact-btn');
        const contactScreen = document.getElementById('contact-screen');
        const backFromContactBtn = document.getElementById('back-from-contact-btn');
        const reviewMenu = document.getElementById('review-menu');
        const vocabularyList = document.getElementById('vocabulary-list');
        const loginScreen = document.getElementById('login-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const autoReviewScreen = document.getElementById('auto-review-screen');
        
        const grade4Btn = document.getElementById('grade4-btn');
        const grade5Btn = document.getElementById('grade5-btn');
        const grade6Btn = document.getElementById('grade6-btn');
        const grade7Btn = document.getElementById('grade7-btn');
        const grade8Btn = document.getElementById('grade8-btn');
        const grade9Btn = document.getElementById('grade9-btn');
        
        const reviewBtn = document.getElementById('review-btn');
        const practiceBtn = document.getElementById('practice-btn');
        const grammarBtn = document.getElementById('grammar-btn');
        
        const showVocabularyBtn = document.getElementById('show-vocabulary-btn');
        const autoReviewBtn = document.getElementById('auto-review-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const backToReviewBtn = document.getElementById('back-to-review-btn');
        const backToMainFromLoginBtn = document.getElementById('back-to-main-from-login-btn');
        const backToGradeBtn = document.getElementById('back-to-grade-btn');
        const backToGradeFromResultBtn = document.getElementById('back-to-grade-from-result-btn');
        
        const startBtn = document.getElementById('start-btn');
        const comprehensiveTestBtn = document.getElementById('comprehensive-test-btn');
        const usernameInput = document.getElementById('username');
        const questionCountSelect = document.getElementById('question-count');
        const unitSelect = document.getElementById('unit-select');
        const reviewUnitSelect = document.getElementById('review-unit-select');
        const wordElement = document.getElementById('word');
        const optionsElement = document.getElementById('options');
        const timerBar = document.getElementById('timer-bar');
        const streakElement = document.getElementById('streak');
        const questionCounterElement = document.getElementById('question-counter');
        const restartBtn = document.getElementById('restart-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const wrongQuestionsElement = document.getElementById('wrong-questions');
        const answerHistoryBody = document.getElementById('answer-history-body');
        const speakerBtn = document.getElementById('speaker-btn');
        const unitTitleElement = document.getElementById('unit-title');
        const resultUnitTitleElement = document.getElementById('result-unit-title');
        const loadingContainer = document.getElementById('loading-container');
        const loadingBar = document.getElementById('loading-bar');
        const vocabularyTableBody = document.getElementById('vocabulary-table-body');
        const vocabularyUnitTitle = document.getElementById('vocabulary-unit-title');
        const gradeHeader = document.getElementById('grade-header');
        const reviewGradeHeader = document.getElementById('review-grade-header');
        const vocabGradeHeader = document.getElementById('vocab-grade-header');
        const loginGradeHeader = document.getElementById('login-grade-header');
        const quizGradeHeader = document.getElementById('quiz-grade-header');
        const resultGradeHeader = document.getElementById('result-grade-header');
        const autoReviewGradeHeader = document.getElementById('auto-review-grade-header');
        const quizUnitTitle = document.getElementById('quiz-unit-title');
        const reviewUnitTitle = document.getElementById('review-unit-title');
        const loginUnitTitle = document.getElementById('login-unit-title');
        const autoReviewUnitTitle = document.getElementById('auto-review-unit-title');
        const questionTextLabel = document.getElementById('question-text-label');
        
        // Các phần tử mới cho ôn bài tự động
        const autoReviewWord = document.getElementById('auto-review-word');
        const autoReviewMeaning = document.getElementById('auto-review-meaning');
        const autoReviewSpeakerBtn = document.getElementById('auto-review-speaker-btn');
        const autoReviewEndButtons = document.getElementById('auto-review-end-buttons');
        const autoReviewAgainBtn = document.getElementById('auto-review-again-btn');
        const autoReviewBackBtn = document.getElementById('auto-review-back-btn');
        const cheatingAlertBox = document.getElementById('cheating-alert-box');

        // Toast function
        function showToast(message, type = 'warning') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // --- CHỨC NĂNG CHỐNG GIAN LẬN (ANTI-CHEAT) ---
        
        // Hàm kích hoạt khi phát hiện gian lận
        function triggerCheating() {
            if (isCheatingDetected) return; // Đã kích hoạt rồi thì không làm gì nữa
            
            isCheatingDetected = true;
            
            // 1. Dừng ngay lập tức mọi hoạt động
            if (timer) clearInterval(timer);
            speechSynthesis.cancel();
            if (transitionTimeout) clearTimeout(transitionTimeout);
            
            // 2. Chuyển thẳng sang màn hình kết quả
            // Không cần alert để tránh người dùng mất tập trung hoặc tắt tab nhanh hơn
            // Màn hình result sẽ hiện thông báo đỏ.
            endGame();
        }

        // Lắng nghe sự kiện chuyển tab hoặc ẩn trang
        document.addEventListener("visibilitychange", () => {
            // Chỉ kích hoạt nếu đang ở màn hình làm bài VÀ chưa bị bắt gian lận trước đó
            if (document.hidden && !quizScreen.classList.contains('hidden') && !isCheatingDetected) {
                triggerCheating();
            }
        });

        // Lắng nghe sự kiện click ra ngoài trình duyệt (blur window)
        window.addEventListener("blur", () => {
            // Chỉ kích hoạt nếu đang ở màn hình làm bài VÀ chưa bị bắt gian lận trước đó
            if (!quizScreen.classList.contains('hidden') && !isCheatingDetected) {
                triggerCheating();
            }
        });

        // Xử lý sự kiện chọn lớp
        grade4Btn.addEventListener('click', () => selectGrade('E4'));
        grade5Btn.addEventListener('click', () => selectGrade('E5'));
        grade6Btn.addEventListener('click', () => selectGrade('E6'));
        grade7Btn.addEventListener('click', () => selectGrade('E7'));
        grade8Btn.addEventListener('click', () => selectGrade('E8'));
        grade9Btn.addEventListener('click', () => selectGrade('E9'));

        // Xử lý sự kiện cho chức năng liên hệ
        contactBtn.addEventListener('click', showContactScreen);
        backFromContactBtn.addEventListener('click', backToGradeSelection);

        function showContactScreen() {
            gradeSelection.classList.add('hidden');
            contactScreen.classList.remove('hidden');
        }

        function selectGrade(grade) {
            currentGrade = grade;
            
            // Xác định số lượng Unit tối đa cho lớp đã chọn
            if (grade === 'E4' || grade === 'E5') {
                maxUnits = 20;
            } else {
                maxUnits = 12;
            }

            gradeSelection.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            
            updateHeaderTitles(grade);
            
            // Cập nhật danh sách Unit cho dropdowns
            populateUnitDropdowns();
            
            // Cập nhật trạng thái hiển thị các nút Range Test
            updateRangeTestButtonsVisibility();
        }

        function populateUnitDropdowns() {
            // Xóa các option cũ
            unitSelect.innerHTML = '<option value="" disabled selected>HÃY CHỌN UNIT</option>';
            reviewUnitSelect.innerHTML = '';
            
            for (let i = 1; i <= maxUnits; i++) {
                const unitName = `UNIT ${i}`;
                
                // Thêm vào unitSelect (Màn hình Login)
                const opt1 = document.createElement('option');
                opt1.value = unitName;
                opt1.textContent = unitName;
                unitSelect.appendChild(opt1);
                
                // Thêm vào reviewUnitSelect (Màn hình Review)
                const opt2 = document.createElement('option');
                opt2.value = unitName;
                opt2.textContent = unitName;
                reviewUnitSelect.appendChild(opt2);
            }
        }

        function updateRangeTestButtonsVisibility() {
            const btnU11U15 = document.getElementById('range-u11-u15-btn');
            const btnU16U20 = document.getElementById('range-u16-u20-btn');
            const btnU11U20 = document.getElementById('range-u11-u20-btn');
            
            // Nếu là lớp 4, 5 (có 20 unit) thì hiện hết các nút
            if (maxUnits === 20) {
                btnU11U15.classList.remove('hidden');
                btnU16U20.classList.remove('hidden');
                btnU11U20.classList.remove('hidden');
            } else {
                // Nếu là lớp 6-9 (chỉ 12 unit) thì ẩn các nút liên quan đến unit 13+
                btnU11U15.classList.add('hidden');
                btnU16U20.classList.add('hidden');
                btnU11U20.classList.add('hidden');
            }
        }

        function updateHeaderTitles(grade) {
            const gradeNumber = grade.replace('E', '');
            const baseTitle = ` ÔN TẬP LỚP ${gradeNumber}`;
            gradeHeader.textContent = baseTitle;
            reviewGradeHeader.textContent = baseTitle;
            vocabGradeHeader.textContent = baseTitle;
            loginGradeHeader.textContent = baseTitle;
            quizGradeHeader.textContent = baseTitle;
            resultGradeHeader.textContent = baseTitle;
            autoReviewGradeHeader.textContent = `ÔN TẬP GS VOCA ${gradeNumber}`;
        }

        // --- Chế độ Từ vựng ---
        reviewBtn.addEventListener('click', () => {
            mainMenu.classList.add('hidden');
            reviewMenu.classList.remove('hidden');
            reviewUnitTitle.textContent = "Chọn đề bài ôn tập";
        });

        practiceBtn.addEventListener('click', () => {
            setModeAndOpenLogin('vocab');
        });

        // --- Chế độ Ngữ pháp ---
        grammarBtn.addEventListener('click', () => {
            setModeAndOpenLogin('grammar');
        });

        function setModeAndOpenLogin(mode) {
            currentMode = mode;
            mainMenu.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            // Reset dropdowns khi entering login screen
            unitSelect.value = "";
            updateQuestionCountOptions();
            
            if (mode === 'vocab') {
                loginUnitTitle.textContent = "Chọn đề bài từ vựng";
            } else {
                loginUnitTitle.textContent = "Chọn bài tập ngữ pháp";
            }
        }

        showVocabularyBtn.addEventListener('click', showVocabularyList);
        autoReviewBtn.addEventListener('click', startAutoReview);
        backToMainBtn.addEventListener('click', backToFirstScreen);
        backToReviewBtn.addEventListener('click', backToReviewMenu);
        backToMainFromLoginBtn.addEventListener('click', backToFirstScreen);
        backToGradeBtn.addEventListener('click', backToGradeSelection);
        backToGradeFromResultBtn.addEventListener('click', backToGradeSelection);

        startBtn.addEventListener('click', startGame);
        comprehensiveTestBtn.addEventListener('click', startComprehensiveTest);
        
        // CẬP NHẬT CÁC NÚT RANGE TEST THEO YÊU CẦU MỚI (20 UNIT CHO LỚP 4,5)
        document.getElementById('range-u1-u5-btn').addEventListener('click', () => startRangeTest(1, 5, "KIỂM TRA U1-U5"));
        document.getElementById('range-u6-u10-btn').addEventListener('click', () => startRangeTest(6, 10, "KIỂM TRA U6-U10"));
        document.getElementById('range-u1-u10-btn').addEventListener('click', () => startRangeTest(1, 10, "KIỂM TRA U1-U10"));
        document.getElementById('range-u11-u15-btn').addEventListener('click', () => startRangeTest(11, 15, "KIỂM TRA U11-U15"));
        document.getElementById('range-u16-u20-btn').addEventListener('click', () => startRangeTest(16, 20, "KIỂM TRA U16-U20"));
        document.getElementById('range-u11-u20-btn').addEventListener('click', () => startRangeTest(11, 20, "KIỂM TRA U11-U20"));

        restartBtn.addEventListener('click', restartGame);
        newGameBtn.addEventListener('click', newGame);
        
        speakerBtn.addEventListener('click', () => {
            speakerBtn.classList.add('active');
            setTimeout(() => {
                speakerBtn.classList.remove('active');
            }, 200);
            speak(currentWord);
        });

        autoReviewSpeakerBtn.addEventListener('click', () => {
            autoReviewSpeakerBtn.classList.add('active');
            setTimeout(() => {
                autoReviewSpeakerBtn.classList.remove('active');
            }, 200);
            speak(autoReviewQuestions[autoReviewIndex].word);
        });
        
        autoReviewAgainBtn.addEventListener('click', restartAutoReview);
        autoReviewBackBtn.addEventListener('click', backToReviewMenu);
        
        unitSelect.addEventListener('change', function() {
            currentUnit = this.value;
            quizUnitTitle.textContent = currentUnit;
            updateQuestionCountOptions();
            resetComprehensiveTestState();
        });

        reviewUnitSelect.addEventListener('change', function() {
            currentUnit = this.value;
        });

        // Hàm lấy dữ liệu dựa trên Mode hiện tại
        function getQuestionBank() {
            let data = {};
            if (currentMode === 'vocab') {
                data = gradeData;
            } else {
                data = grammarData;
            }

            if (!currentGrade || !data[currentGrade] || !data[currentGrade].units[currentUnit]) {
                return [];
            }
            return data[currentGrade].units[currentUnit];
        }

        function showVocabularyList() {
            const questionBank = getQuestionBank();
            
            if (questionBank.length === 0) {
                showToast("Chưa có dữ liệu cho unit này!", "warning");
                return;
            }
            
            reviewMenu.classList.add('hidden');
            vocabularyList.classList.remove('hidden');
            vocabularyUnitTitle.textContent = currentUnit;
            
            vocabularyTableBody.innerHTML = '';
            
            questionBank.forEach((question, index) => {
                const row = document.createElement('tr');
                
                const idCell = document.createElement('td');
                idCell.textContent = index + 1;
                row.appendChild(idCell);
                
                const wordCell = document.createElement('td');
                const wordContainer = document.createElement('div');
                wordContainer.className = 'vocabulary-word';
                
                const wordSpan = document.createElement('span');
                wordSpan.textContent = question.word;
                
                const speakerBtn = document.createElement('button');
                speakerBtn.className = 'speaker-btn'; 
                speakerBtn.title = 'Nghe phát âm';
                speakerBtn.innerHTML = `<svg class="speaker-icon" viewBox="0 0 24 24"><path d="M3,9v6h4l5,5V4L7,9H3z M16.5,12c0-1.77-1.02-3.29-2.5-4.03v8.05C15.48,15.29,16.5,13.77,16.5,12z M14,3.23v2.06c2.89,.86,5,3.54,5,6.71s-2.11,5.85-5,6.71v2.06c4.01-.91,7-4.49,7-8.77S18.01,4.14,14,3.23z"/></svg>`;
                speakerBtn.addEventListener('click', () => speak(question.word));
                
                wordContainer.appendChild(wordSpan);
                wordContainer.appendChild(speakerBtn);
                wordCell.appendChild(wordContainer);
                row.appendChild(wordCell);
                
                const meaningCell = document.createElement('td');
                meaningCell.textContent = question.correct;
                row.appendChild(meaningCell);
                
                vocabularyTableBody.appendChild(row);
            });
        }

        function startAutoReview() {
            autoReviewQuestions = getQuestionBank();
            
            if (autoReviewQuestions.length === 0) {
                showToast("Chưa có dữ liệu cho unit này!", "warning");
                return;
            }
            
            reviewMenu.classList.add('hidden');
            autoReviewScreen.classList.remove('hidden');
            autoReviewUnitTitle.textContent = currentUnit;
            
            autoReviewIndex = 0;
            autoReviewEndButtons.classList.add('hidden');
            showAutoReviewQuestion();
        }

        function showAutoReviewQuestion() {
            if (autoReviewIndex >= autoReviewQuestions.length) {
                endAutoReview();
                return;
            }
            
            const question = autoReviewQuestions[autoReviewIndex];
            autoReviewWord.textContent = question.word;
            autoReviewMeaning.textContent = question.correct;
            
            autoReviewWord.classList.remove('black');
            
            clearTimeout(autoReviewSpeakTimer1);
            clearTimeout(autoReviewSpeakTimer2);
            
            autoReviewSpeakTimer1 = setTimeout(() => {
                speak(question.word);
            }, 400);
            
            autoReviewSpeakTimer2 = setTimeout(() => {
                speak(question.word);
            }, 2400);
            
            setTimeout(() => {
                autoReviewWord.classList.add('black');
            }, 2500);
            
            autoReviewTimer = setTimeout(() => {
                autoReviewIndex++;
                showAutoReviewQuestion();
            }, 4000);
        }

        function endAutoReview() {
            clearTimeout(autoReviewTimer);
            clearTimeout(autoReviewSpeakTimer1);
            clearTimeout(autoReviewSpeakTimer2);
            autoReviewEndButtons.classList.remove('hidden');
            
            autoReviewWord.textContent = "Hoàn thành!";
            autoReviewMeaning.textContent = `Đã ôn ${autoReviewQuestions.length} từ vựng`;
        }

        function restartAutoReview() {
            clearTimeout(autoReviewTimer);
            clearTimeout(autoReviewSpeakTimer1);
            clearTimeout(autoReviewSpeakTimer2);
            autoReviewEndButtons.classList.remove('hidden');
            
            speechSynthesis.cancel();
            
            autoReviewIndex = 0;
            autoReviewEndButtons.classList.add('hidden');
            showAutoReviewQuestion();
        }

        function backToFirstScreen() {
            clearTimeout(autoReviewTimer);
            clearTimeout(autoReviewSpeakTimer1);
            clearTimeout(autoReviewSpeakTimer2);
            autoReviewEndButtons.classList.remove('hidden');
            
            loginScreen.classList.add('hidden');
            reviewMenu.classList.add('hidden');
            vocabularyList.classList.add('hidden');
            autoReviewScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            
            mainMenu.classList.remove('hidden');
            unitTitleElement.textContent = "Chọn chế độ";
            resetComprehensiveTestState();
        }

        function backToGradeSelection() {
            contactScreen.classList.add('hidden');
            mainMenu.classList.add('hidden');
            reviewMenu.classList.add('hidden');
            vocabularyList.classList.add('hidden');
            autoReviewScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            
            gradeSelection.classList.remove('hidden');
            resetComprehensiveTestState();
        }

        function backToReviewMenu() {
            clearTimeout(autoReviewTimer);
            autoReviewEndButtons.classList.remove('hidden');
            
            clearTimeout(autoReviewSpeakTimer1);
            clearTimeout(autoReviewSpeakTimer2);
            speechSynthesis.cancel();
            
            vocabularyList.classList.add('hidden');
            autoReviewScreen.classList.add('hidden');
            reviewMenu.classList.remove('hidden');
        }

        function updateQuestionCountOptions() {
            const questionBank = getQuestionBank();
            const maxQuestions = questionBank.length;
            
            questionCountSelect.innerHTML = '';
            
            // Thêm Option mặc định "HÃY CHỌN SỐ CÂU HỎI"
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "HÃY CHỌN SỐ CÂU HỎI";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            questionCountSelect.appendChild(defaultOption);
            
            if (maxQuestions === 0) {
                return;
            }

            const options = [
                { value: 10, text: "10 câu" },
                { value: 20, text: "20 câu" },
                { value: 30, text: "30 câu" },
                { value: 40, text: "40 câu" },
                { value: 50, text: "50 câu" },
                { value: maxQuestions, text: `${maxQuestions} câu (tất cả)` }
            ];
            
            const validOptions = options.filter(option => option.value <= maxQuestions);
            
            validOptions.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                questionCountSelect.appendChild(optionElement);
            });
        }

        function startComprehensiveTest() {
            // Lấy random 40 câu từ tất cả các Unit có sẵn (1 đến maxUnits)
            startRangeTest(1, maxUnits, "KIỂM TRA TỔNG HỢP");
        }

        function startRangeTest(startUnitNum, endUnitNum, title) {
            username = usernameInput.value.trim();
            if (!username) {
                showToast("Vui lòng nhập tên của bạn!", "error");
                return;
            }
            
            const dataSource = currentMode === 'vocab' ? gradeData : grammarData;
            
            comprehensivePool = [];
            const gradeUnits = dataSource[currentGrade].units;
            
            for (const unitName in gradeUnits) {
                const unitNum = parseInt(unitName.split(' ')[1]);
                
                if (unitNum >= startUnitNum && unitNum <= endUnitNum) {
                    const unitQuestions = gradeUnits[unitName];
                    unitQuestions.forEach(q => {
                        const questionCopy = Object.assign({}, q);
                        questionCopy.unitAddress = `${unitName} - Câu ${q.id}`;
                        comprehensivePool.push(questionCopy);
                    });
                }
            }
            
            if (comprehensivePool.length === 0) {
                showToast("Chưa có dữ liệu cho khoảng Unit này!", "error");
                return;
            }
            
            isComprehensiveTest = true;
            // Lấy ngẫu nhiên 40 câu như yêu cầu
            questionCount = Math.min(40, comprehensivePool.length);
            
            currentTestTitle = title;
            
            questionCountSelect.disabled = true;
            questionCountSelect.value = questionCount;
            
            loadingContainer.classList.remove('hidden');
            startBtn.disabled = true;
            comprehensiveTestBtn.disabled = true;
            document.querySelectorAll('.range-tests-container button').forEach(b => b.disabled = true);
            
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += 5;
                loadingBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(loadingInterval);
                    loadingContainer.classList.add('hidden');
                    startBtn.disabled = false;
                    comprehensiveTestBtn.disabled = false;
                    document.querySelectorAll('.range-tests-container button').forEach(b => b.disabled = false);
                    startQuizWithPool(comprehensivePool, questionCount, currentTestTitle);
                }
            }, 50);
        }

        function startQuizWithPool(pool, count, title) {
            startTime = new Date();
            
            // Reset cờ gian lận khi bắt đầu game mới (trừ trường hợp restart vẫn giữ cờ nếu muốn, 
            // nhưng theo yêu cầu "làm lại/xóa ghi nhận" thì reset ở restartGame. 
            // Tuy nhiên startQuizWithPool được gọi từ startGame và startRangeTest.
            // Để an toàn, ta không reset cờ ở đây, mà reset ở các nút bấm menu.
            
            selectedQuestions = getRandomQuestions(pool, count);
            
            currentQuestionIndex = 0;
            score = 0;
            streak = 0;
            maxStreak = 0;
            totalTime = 0;
            questionTimes = [];
            wrongQuestions = [];
            answerHistory = [];
            selectedOptions = Array(selectedQuestions.length).fill(null);
            
            quizUnitTitle.textContent = title;
            resultUnitTitleElement.textContent = title;
            
            loginScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultScreen.classList.add('hidden');
            
            if (currentMode === 'grammar') {
                speakerBtn.classList.add('hidden-speaker');
                questionTextLabel.textContent = "Chọn đáp án đúng cho câu sau:";
            } else {
                speakerBtn.classList.remove('hidden-speaker');
                questionTextLabel.textContent = "Chọn nghĩa đúng cho từ sau:";
            }
            
            showQuestion();
        }

        function startGame() {
            username = usernameInput.value.trim();
            if (!username) {
                showToast("Vui lòng nhập tên của bạn!", "error");
                return;
            }
            
            if (!currentUnit) {
                showToast("Vui lòng chọn đề bài!", "error");
                unitSelect.focus();
                return;
            }
            
            const qCountVal = questionCountSelect.value;
            if (!qCountVal) {
                showToast("Vui lòng chọn số câu hỏi!", "error");
                questionCountSelect.focus();
                return;
            }
            
            currentTestTitle = currentUnit;
            
            questionCount = parseInt(qCountVal);
            
            const questionBank = getQuestionBank();
            
            if (questionCount < 1 || questionCount > questionBank.length) {
                showToast(`Vui lòng chọn số câu hỏi từ 1 đến ${questionBank.length}`, "error");
                return;
            }
            
            loadingContainer.classList.remove('hidden');
            startBtn.disabled = true;
            comprehensiveTestBtn.disabled = true;
            
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += 5;
                loadingBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(loadingInterval);
                    loadingContainer.classList.add('hidden');
                    startBtn.disabled = false;
                    comprehensiveTestBtn.disabled = false;
                    startQuizWithPool(questionBank, questionCount, currentUnit);
                }
            }, 50);
        }

        function getRandomQuestions(questionBank, n) {
            const shuffled = questionBank.slice();
            shuffleArray(shuffled);
            return shuffled.slice(0, n);
        }

        function showQuestion() {
            // Nếu đã bị bắt gian lận rồi thì không hiển thị tiếp câu hỏi
            if (isCheatingDetected) return;

            if (currentQuestionIndex >= selectedQuestions.length) {
                endGame();
                return;
            }
            
            const question = selectedQuestions[currentQuestionIndex];
            currentWord = question.word;
            wordElement.textContent = question.word;
            
            questionCounterElement.textContent = `Câu ${currentQuestionIndex + 1}/${selectedQuestions.length}`;
            streakElement.textContent = `Chuỗi đúng: ${streak}`;
            
            optionsElement.innerHTML = '';
            
            const options = [
                question.correct,
                question.wrong1,
                question.wrong2,
                question.wrong3
            ];
            
            shuffleArray(options);
            
            options.forEach((option, index) => {
                const optionButton = document.createElement('div');
                optionButton.classList.add('option');
                optionButton.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                optionButton.addEventListener('click', () => selectOption(option, question.correct, question.id, question.word));
                optionsElement.appendChild(optionButton);
            });
            
            startTimer();
            
            if (currentMode === 'vocab') {
                setTimeout(() => {
                    speak(question.word);
                }, 500);
            }
        }

        function startTimer() {
            const startTime = Date.now();
            
            let maxTime = 8; 
            if (currentMode === 'grammar') {
                maxTime = 20;
            }
            
            timeLeft = maxTime; 
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#FFD700';
            
            if (timer) {
                clearInterval(timer);
            }
            
            timer = setInterval(() => {
                // Nếu bị phát hiện gian lận, dừng timer ngay
                if (isCheatingDetected) {
                    clearInterval(timer);
                    return;
                }

                timeLeft -= 0.1;
                timerBar.style.width = `${(timeLeft / maxTime) * 100}%`;
                
                if (timeLeft <= 3) {
                    timerBar.style.backgroundColor = '#FF6347';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    const endTime = Date.now();
                    questionTimes.push(maxTime);
                    totalTime += maxTime;
                    handleAnswer(false, selectedQuestions[currentQuestionIndex].id, selectedQuestions[currentQuestionIndex].word, "Không chọn");
                }
            }, 100);
        }

        function selectOption(selectedOption, correctAnswer, questionId, questionWord) {
            // Nếu đã bị bắt gian lận thì không xử lý click
            if (isCheatingDetected) return;

            const endTime = Date.now();
            clearInterval(timer);
            const isCorrect = selectedOption === correctAnswer;
            
            let timeTaken = 0;
            if (currentMode === 'grammar') {
                 timeTaken = 20 - timeLeft;
            } else {
                 timeTaken = 8 - timeLeft;
            }
            
            questionTimes.push(timeTaken);
            totalTime += timeTaken;
            
            selectedOptions[currentQuestionIndex] = selectedOption;
            
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                if (option.textContent.includes(correctAnswer)) {
                    option.classList.add('correct');
                }
                if (option.textContent.includes(selectedOption) && !isCorrect) {
                    option.classList.add('incorrect');
                }
                option.style.pointerEvents = 'none';
            });
            
            setTimeout(() => {
                handleAnswer(isCorrect, questionId, questionWord, selectedOption);
            }, 100);
        }

        function handleAnswer(isCorrect, questionId, questionWord, selectedOption) {
            // Kiểm tra lại trạng thái gian lận trước khi xử lý (tránh race condition)
            if (isCheatingDetected) return;

            const currentQuestion = selectedQuestions[currentQuestionIndex];
            
            if (isCorrect) {
                score++;
                streak++;
                if (streak > maxStreak) {
                    maxStreak = streak;
                }
            } else {
                streak = 0;
                wrongQuestions.push(questionId);
            }
            
            answerHistory.push({
                id: questionId,
                word: questionWord,
                selected: selectedOption,
                correct: currentQuestion.correct,
                unit: currentUnit,
                unitAddress: currentQuestion.unitAddress || ''
            });
            
            currentQuestionIndex++;
            
            // Sử dụng transitionTimeout để có thể hủy nếu cần
            transitionTimeout = setTimeout(() => {
                showQuestion();
            }, 400);
        }

        function endGame() {
            // Dừng mọi thứ khi kết thúc
            if (timer) clearInterval(timer);
            if (transitionTimeout) clearTimeout(transitionTimeout);
            speechSynthesis.cancel();
            
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            
            endTime = new Date();
            
            // Tổng số câu ban đầu (Dù có làm hết hay không)
            const totalQuestions = selectedQuestions.length; 
            
            // Phần trăm tính dựa trên tổng số câu đã chọn ban đầu
            const percentage = Math.round((score / totalQuestions) * 100);

            const resultName = document.getElementById('result-name');
            
            // --- CHỈNH SỬA 1: HIỂN THỊ TÊN NGƯỜI DÙNG ---
            // Nếu username rỗng thì hiển thị "Học sinh", ngược lại hiển thị username
            resultName.textContent = username.trim() ? username.trim() : "Học sinh";
            // -----------------------------------------------

            const resultHeader = document.getElementById('result-grade-header');
            const resultScreenEl = document.getElementById('result-screen');

            // Xử lý hiển thị thông báo gian lận
            if (isCheatingDetected) {
                cheatingAlertBox.style.display = 'block';
            } else {
                cheatingAlertBox.style.display = 'none';
            }

            if (currentMode === 'grammar') {
                resultName.style.color = 'var(--grammar-blue)'; 
                resultHeader.style.color = 'var(--grammar-blue)';
                resultScreenEl.classList.remove('vocab-result-mode');
                resultScreenEl.classList.add('grammar-result-mode');
            } else {
                resultName.style.color = 'var(--vocab-dark-green)'; 
                resultHeader.style.color = 'var(--vocab-dark-green)';
                resultScreenEl.classList.remove('grammar-result-mode');
                resultScreenEl.classList.add('vocab-result-mode');
            }

            document.getElementById('result-date-summary').textContent = startTime.toLocaleDateString('vi-VN');

            document.getElementById('result-score-correct').textContent = score;
            document.getElementById('result-score-total').textContent = totalQuestions;
            document.getElementById('score-percentage-text').textContent = `${percentage}%`;

            const circlePath = document.getElementById('score-circle-path');
            circlePath.style.strokeDasharray = `${percentage}, 100`;
            
            let scoreColor = '#f5222d'; 
            if (percentage >= 50 && percentage <= 69) { scoreColor = '#faad14'; } 
            else if (percentage >= 70 && percentage <= 79) { scoreColor = '#52c41a'; } 
            else if (percentage >= 80 && percentage <= 89) { scoreColor = '#13c2c2'; } 
            else if (percentage >= 90 && percentage <= 99) { scoreColor = '#1890ff'; } 
            else if (percentage === 100) { scoreColor = '#722ed1'; }
            
            // Nếu gian lận, ép màu đỏ cho biểu đồ
            if (isCheatingDetected) scoreColor = '#f44336';
            
            circlePath.style.stroke = scoreColor;
            
            const percentageText = document.getElementById('score-percentage-text');
            percentageText.style.fill = scoreColor;

            // --- CHỈNH SỬA: THÊM GIÂY VÀO ĐỊNH DẠNG GIỜ ---
            const startOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const startDateOptions = { day: '2-digit', month: '2-digit' };
            
            document.getElementById('result-start-time').textContent = startTime.toLocaleTimeString('vi-VN', startOptions);
            document.getElementById('result-start-date').textContent = startTime.toLocaleDateString('vi-VN', startDateOptions);

            // --- CHỈNH SỬA: THÊM GIÂY VÀO ĐỊNH DẠNG GIỜ ---
            const endOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const endDateOptions = { day: '2-digit', month: '2-digit' };
            
            document.getElementById('result-end-time').textContent = endTime.toLocaleTimeString('vi-VN', endOptions);
            document.getElementById('result-end-date').textContent = endTime.toLocaleDateString('vi-VN', endDateOptions);
            // ---------------------------------------------

            document.getElementById('result-max-streak').textContent = maxStreak;
            document.getElementById('result-total-time').textContent = `${totalTime.toFixed(1)}s`;

            const modeText = currentMode === 'vocab' ? "TỪ VỰNG" : "NGỮ PHÁP";
            document.getElementById('result-grade-header').textContent = `ÔN TẬP LỚP ${currentGrade.replace('E','')} – ${modeText}`;

            wrongQuestionsElement.innerHTML = '';
            if (wrongQuestions.length === 0) {
                wrongQuestionsElement.innerHTML = '<li style="color:#4CAF50;font-weight:bold;">Không có câu sai nào! Xuất sắc!</li>';
            } else {
                const wrongQuestionsInOrder = answerHistory
                    .filter(item => item.selected !== item.correct)
                    .map(item => item.unitAddress || `${item.unit} - Câu ${item.id}`);
                    
                wrongQuestionsInOrder.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    wrongQuestionsElement.appendChild(li);
                });
            }
            
            // Hiển thị lịch sử chi tiết
            // Ở đây answerHistory chỉ chứa các câu ĐÃ LÀM. 
            // Nên sẽ tự động không hiển thị các câu chưa làm (yêu cầu 1.1)
            answerHistoryBody.innerHTML = '';
            answerHistory.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const idCell = document.createElement('td');
                idCell.textContent = index + 1;
                row.appendChild(idCell);
                
                const wordCell = document.createElement('td');
                const wordContainer = document.createElement('div');
                wordContainer.className = 'vocabulary-word';
                
                const wordSpan = document.createElement('span');
                if (item.unitAddress) {
                    wordSpan.textContent = `[${item.unitAddress}] ${item.word}`;
                } else {
                    wordSpan.textContent = item.word;
                }
                
                if (currentMode === 'vocab') {
                    const speakerBtn = document.createElement('button');
                    speakerBtn.className = 'speaker-btn'; 
                    speakerBtn.title = 'Nghe phát âm';
                    speakerBtn.innerHTML = `<svg class="speaker-icon" viewBox="0 0 24 24"><path d="M3,9v6h4l5,5V4L7,9H3z M16.5,12c0-1.77-1.02-3.29-2.5-4.03v8.05C15.48,15.29,16.5,13.77,16.5,12z M14,3.23v2.06c2.89,.86,5,3.54,5,6.71s-2.11,5.85-5,6.71v2.06c4.01-.91,7-4.49,7-8.77S18.01,4.14,14,3.23z"/></svg>`;
                    speakerBtn.addEventListener('click', () => speak(item.word));
                    wordContainer.appendChild(wordSpan);
                    wordContainer.appendChild(speakerBtn);
                } else {
                    wordContainer.appendChild(wordSpan);
                }
                
                wordCell.appendChild(wordContainer);
                row.appendChild(wordCell);
                
                const selectedCell = document.createElement('td');
                selectedCell.textContent = item.selected;
                if (item.selected !== item.correct) {
                    selectedCell.style.color = '#f44336';
                    selectedCell.style.fontWeight = 'bold';
                }
                row.appendChild(selectedCell);
                
                const correctCell = document.createElement('td');
                correctCell.textContent = item.correct;
                correctCell.style.fontWeight = 'bold';
                row.appendChild(correctCell);
                
                answerHistoryBody.appendChild(row);
            });
        }

        function restartGame() {
            // Yêu cầu 1.2: Nếu nhấp làm lại thì xóa ghi nhận phát hiện gian lận
            isCheatingDetected = false;
            
            let pool = [];
            if (isComprehensiveTest && comprehensivePool.length > 0) {
                pool = comprehensivePool;
            } else {
                pool = getQuestionBank();
            }
            selectedQuestions = getRandomQuestions(pool, selectedQuestions.length);
            
            currentQuestionIndex = 0;
            score = 0;
            streak = 0;
            totalTime = 0;
            questionTimes = [];
            wrongQuestions = [];
            answerHistory = [];
            selectedOptions = Array(selectedQuestions.length).fill(null);
            
            startTime = new Date();
            resultScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            
            if (currentMode === 'grammar') {
                speakerBtn.classList.add('hidden-speaker');
                questionTextLabel.textContent = "Chọn đáp án đúng cho câu sau:";
            } else {
                speakerBtn.classList.remove('hidden-speaker');
                questionTextLabel.textContent = "Chọn nghĩa đúng cho từ sau:";
            }
            
            showQuestion();
        }

        function newGame() {
            // Yêu cầu 1.2: Nếu nhấp chơi mới thì xóa ghi nhận phát hiện gian lận
            isCheatingDetected = false;
            resetComprehensiveTestState();
            resultScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            unitSelect.value = "";
            updateQuestionCountOptions();
            
            if (currentMode === 'vocab') {
                loginUnitTitle.textContent = "Chọn đề bài trắc nghiệm từ vựng";
            } else {
                loginUnitTitle.textContent = "Chọn đề bài tập ngữ pháp";
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                
                utterance.onerror = function(event) {
                    console.error('Speech synthesis error:', event.error);
                };
                
                speechSynthesis.speak(utterance);
            } else {
                console.warn('Speech synthesis not supported in this browser');
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function resetComprehensiveTestState() {
            isComprehensiveTest = false;
            comprehensivePool = [];
            questionCountSelect.disabled = false;
        }
        
        // Khởi tạo ban đầu
        updateQuestionCountOptions();
    </script>
</body>
</html>
